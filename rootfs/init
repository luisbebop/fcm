#!/bin/sh
#
# Minimal init script for Firecracker VMs
#

# Log file for debugging
LOG=/var/log/init.log

log() {
    echo "$1"
    echo "$1" >> $LOG 2>/dev/null
}

log ">>> init: starting"

# Mount essential filesystems (ignore errors if already mounted)
mountpoint -q /proc || mount -t proc proc /proc
mountpoint -q /sys || mount -t sysfs sysfs /sys
mountpoint -q /dev || mount -t devtmpfs devtmpfs /dev

log ">>> init: filesystems mounted"

# Create pts mount point
mkdir -p /dev/pts
mountpoint -q /dev/pts || mount -t devpts devpts /dev/pts

mkdir -p /var/log
log ">>> init: devices ready"

# Network is pre-configured by kernel boot args
ip link set eth0 up 2>/dev/null || true
log ">>> init: network up"

# Set up DNS
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf

# Create necessary directories
mkdir -p /run/sshd

log ">>> init: initializing entropy"

# Use rngd to feed entropy from /dev/urandom to /dev/random
# This marks the kernel RNG as initialized
rngd -r /dev/urandom -o /dev/random -f &
sleep 2
log ">>> init: rngd started"

log ">>> init: starting dropbear ssh (step 1)"

# Start dropbear SSH server (simpler than OpenSSH)
# -R: generate host keys if missing
# -F: foreground (we'll background it ourselves)
# -E: log to stderr
dropbear -R -F -E >> $LOG 2>&1 &
DROPBEAR_PID=$!

sleep 2

if kill -0 $DROPBEAR_PID 2>/dev/null; then
    log ">>> init: dropbear running (pid $DROPBEAR_PID)"
else
    log ">>> init: dropbear DIED"
fi

# Check if dropbear is listening
log ">>> init: checking if ssh is listening"
ss -tlnp 2>&1 >> $LOG || netstat -tlnp 2>&1 >> $LOG

log ">>> init: ssh launched (step 2)"

log ">>> init: starting http (step 3)"

# Start HTTP server using python
mkdir -p /www
echo "hello from fcm VM" > /www/index.html
cp $LOG /www/init.log 2>/dev/null || true
cd /www
python3 -m http.server 8000 >> $LOG 2>&1 &
HTTP_PID=$!
sleep 1
if kill -0 $HTTP_PID 2>/dev/null; then
    log ">>> init: http started (pid $HTTP_PID)"
else
    log ">>> init: http failed to start"
fi

# Check ports again after http started
log ">>> init: final port check:"
ss -tlnp 2>&1 >> $LOG || netstat -tlnp 2>&1 >> $LOG || log ">>> init: cannot list ports"

log ">>> init: services started (step 4)"

log "============================================"
log "  fcm VM started"
log "============================================"

# Keep init running forever and update log file periodically
while true; do
    cp $LOG /www/init.log 2>/dev/null || true
    sleep 60
done
