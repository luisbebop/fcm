#!/bin/sh
#
# Minimal init script for Firecracker VMs
#

# Log file for debugging
LOG=/var/log/init.log

log() {
    echo "$1"
    echo "$1" >> $LOG 2>/dev/null
}

log ">>> init: starting"

# Mount essential filesystems (ignore errors if already mounted)
mountpoint -q /proc || mount -t proc proc /proc
mountpoint -q /sys || mount -t sysfs sysfs /sys
mountpoint -q /dev || mount -t devtmpfs devtmpfs /dev

log ">>> init: filesystems mounted"

# Create pts mount point
mkdir -p /dev/pts
mountpoint -q /dev/pts || mount -t devpts devpts /dev/pts

mkdir -p /var/log
log ">>> init: devices ready"

# Network is pre-configured by kernel boot args
ip link set lo up 2>/dev/null || true
ip link set eth0 up 2>/dev/null || true
log ">>> init: network up"

# Set up DNS
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf

# Set up localhost in /etc/hosts (needed for apps binding to localhost)
echo "127.0.0.1   localhost localhost.localdomain" > /etc/hosts
echo "::1         localhost localhost.localdomain" >> /etc/hosts

# Create necessary directories
mkdir -p /run/sshd

log ">>> init: initializing entropy"

# Use rngd to feed entropy from /dev/urandom to /dev/random
# This marks the kernel RNG as initialized
rngd -r /dev/urandom -o /dev/random -f &
sleep 2
log ">>> init: rngd started"

log ">>> init: starting dropbear ssh (step 1)"

# Start dropbear SSH server (simpler than OpenSSH)
# -R: generate host keys if missing
# -F: foreground (we'll background it ourselves)
# -E: log to stderr
dropbear -R -F -E >> $LOG 2>&1 &
DROPBEAR_PID=$!

sleep 2

if kill -0 $DROPBEAR_PID 2>/dev/null; then
    log ">>> init: dropbear running (pid $DROPBEAR_PID)"
else
    log ">>> init: dropbear DIED"
fi

# Check if dropbear is listening
log ">>> init: checking if ssh is listening"
ss -tlnp 2>&1 >> $LOG || netstat -tlnp 2>&1 >> $LOG

log ">>> init: ssh launched (step 2)"

# Start zsh login shell on serial console (ttyS0) for interactive access
# This provides a direct shell without getty overhead
log ">>> init: starting zsh on ttyS0"
setsid sh -c 'exec zsh --login' <>/dev/ttyS0 >&0 2>&1 &

# Create /app directory for Procfile deployments
mkdir -p /app

# Create swap file for memory-intensive operations (gem compilation, etc.)
if [ ! -f /swapfile ]; then
    log ">>> init: creating swap file"
    dd if=/dev/zero of=/swapfile bs=1M count=512 2>/dev/null
    chmod 600 /swapfile
    mkswap /swapfile >/dev/null 2>&1
fi
swapon /swapfile 2>/dev/null || true

log ">>> init: services started"

log "============================================"
log "  fcm VM started"
log "============================================"

# Keep init running
while true; do
    sleep 60
done
