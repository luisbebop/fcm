# FCM Implementation Progress

## Completed Tasks

### Task 1: Project Structure and CLI Parsing
- Created Cargo.toml with dependencies (clap, serde, serde_json, rand, tiny_http, ureq)
- Created src/main.rs with full CLI parsing using clap derive
- Commands implemented: create, ls, ssh, stop, start, destroy, daemon
- Created stub modules: client.rs, daemon.rs, vm.rs, firecracker.rs, network.rs, caddy.rs
- All modules compile, tests pass
- Commit: 4e93d71

### Task 2: VM Config Types and Name Generation
- Implemented VmConfig struct with id, name, ip, state, expose fields
- Implemented VmState enum (Running, Stopped)
- Implemented ExposeConfig struct for port/domain exposure
- Added word lists (ADJECTIVES, NOUNS) per PRD spec
- Implemented generate_id() for 8-char alphanumeric IDs
- Implemented random_name() for adjective-noun combinations
- Added helper methods: dir(), config_path(), rootfs_path(), socket_path(), pid_path()
- Added save() and load() methods for config persistence
- Added list_vms() and find_vm() functions for VM discovery
- Added 9 unit tests covering all functionality
- Commit: a3c8601

### Task 3: Daemon HTTP Server
- Implemented HTTP server on localhost:7777 using tiny_http
- Token-based authentication with Bearer header validation
- Auto-generates 32-char token on first run, saves to /var/lib/firecracker/.token
- Token file has restricted permissions (0600)
- REST API routes implemented:
  - POST /vms - create VM (saves config to disk)
  - GET /vms - list all VMs
  - GET /vms/{id} - get VM details
  - GET /vms/{id}/ssh - get SSH connection info
  - POST /vms/{id}/stop - stop VM
  - POST /vms/{id}/start - start VM
  - DELETE /vms/{id} - destroy VM (removes directory)
- JSON request/response handling with proper error responses
- Root check warning on startup
- Added 7 unit tests for token generation, routing, and serialization
- Added libc dependency for euid check
- Commit: 614b86b

### Task 4: Client HTTP Requests with Token Auth
- Implemented HTTP client using ureq with json feature
- Token loading from FCM_TOKEN env var or ~/.fcm-token file
- Added dirs dependency for cross-platform home directory detection
- make_request() helper for authenticated requests to daemon
- Implemented all client functions:
  - create_vm() - POST /vms with name/expose options
  - list_vms() - GET /vms with formatted table output
  - ssh_vm() - GET /vms/{id}/ssh then exec ssh command
  - stop_vm() - POST /vms/{id}/stop
  - start_vm() - POST /vms/{id}/start
  - destroy_vm() - DELETE /vms/{id}
- Proper error handling for connection failures and HTTP errors
- Added 8 unit tests for serialization, deserialization, and token loading
- Commit: 2c8a1c9

### Task 5: Firecracker API over Unix Socket
- Implemented FirecrackerClient struct for unix socket communication
- HTTP over unix socket with request/response parsing
- Request types: BootSource, Drive, MachineConfig, NetworkInterface
- Action types: InstanceStart, SendCtrlAltDel for VM control
- API methods:
  - set_boot_source() - configure kernel and boot args
  - set_drive() - configure rootfs drive
  - set_machine_config() - configure vcpu count and memory
  - set_network_interface() - configure network interface with MAC
  - start_instance() - start the VM
  - send_ctrl_alt_del() - graceful shutdown
  - get_instance_info() - get VM status
  - is_available() - check socket connectivity
- Helper functions: generate_mac(), build_boot_args()
- FirecrackerError enum with Display impl for error handling
- Added 17 unit tests for serialization, parsing, and helpers
- Commit: f505e61

### Task 6: Network Setup (Tap Devices and IP Allocation)
- Implemented NetworkError enum with Display impl for error handling
- Network constants: GATEWAY (172.16.0.1), SUBNET_MASK, SUBNET_CIDR
- IP allocation from pool (172.16.0.50-254)
- Tap device management:
  - tap_name() - generates tap device name (tap_<vm_id>)
  - create_tap() - creates tap device, brings it up, adds to bridge
  - delete_tap() - removes tap device
- Network bridge setup:
  - setup_network() - creates fcm0 bridge, assigns gateway IP, enables forwarding
  - cleanup_network() - removes bridge and nftables rules
- nftables masquerade setup for NAT (allows VMs to access internet)
- Helper functions:
  - allocate_ip() - finds first available IP in pool
  - get_used_ips() - gets IPs currently in use by VMs
  - parse_last_octet() - parses last octet from IP string
  - is_valid_vm_ip() - validates IP is in VM range
- Added 12 unit tests covering all functionality
- Commit: 670e9c5

### Task 7: Caddy Config Management
- Implemented CaddyError enum with Display impl for error handling
- Added CADDYFILE_PATH constant (/etc/caddy/Caddyfile)
- Server IP detection:
  - get_server_ip() - fetches public IP via ifconfig.me or icanhazip.com
  - is_valid_ipv4() - validates IPv4 address format
- Domain generation:
  - generate_domain() - creates sslip.io domain (e.g., myvm.64-34-93-45.sslip.io)
- Caddyfile management:
  - add_site() / add_site_to_file() - adds reverse proxy block to Caddyfile
  - remove_site() / remove_site_from_file() - removes managed block from Caddyfile
  - generate_caddy_block() - generates Caddy config block with fcm-managed marker
  - remove_site_block() - parses and removes site block using brace counting
  - update_site_in_file() - updates existing site configuration
- Caddy control:
  - reload() - reloads Caddy via systemctl or caddy CLI
  - is_running() - checks if Caddy service is active
  - validate() / validate_file() - validates Caddyfile syntax
- Added tempfile dev-dependency for tests
- Added 12 unit tests covering all functionality
- Commit: 44ac827

### Task 8: VM Lifecycle Management
- Implemented VmError enum that unifies errors from all modules (IO, Network, Firecracker, Caddy)
- Added From implementations for error conversion from all module error types
- Added constants: KERNEL_PATH, BASE_ROOTFS_PATH, DEFAULT_VCPU_COUNT (1), DEFAULT_MEM_SIZE_MIB (512)
- Implemented create_vm():
  - Checks for required kernel and rootfs files
  - Allocates IP from pool via network module
  - Creates VM directory and copies rootfs with sparse support (cp --sparse=always)
  - Creates tap device and adds to bridge
  - Spawns firecracker process
  - Waits for socket availability with configurable timeout
  - Configures boot source, drive, machine config, network interface via Firecracker API
  - Starts the VM instance
  - Configures Caddy if port exposure requested
  - Proper cleanup on any failure (removes directory, tap device, kills process)
- Implemented stop_vm():
  - Validates VM exists and is running
  - Attempts graceful shutdown via Ctrl+Alt+Del
  - Kills firecracker process (SIGTERM then SIGKILL)
  - Deletes tap device
  - Updates VM state to Stopped
- Implemented start_vm():
  - Validates VM exists and is stopped
  - Creates tap device
  - Spawns and configures new firecracker process
  - Starts the VM instance
  - Updates VM state to Running
- Implemented destroy_vm():
  - Stops VM if running (graceful then forced)
  - Deletes tap device
  - Removes Caddy site configuration if exposed
  - Removes VM directory completely
- Helper functions:
  - spawn_firecracker() - spawns firecracker process with API socket
  - kill_firecracker() - kills process by PID from file
  - wait_for_socket() - polls for socket availability with timeout
  - cleanup_failed_vm() - cleanup helper for create failures
  - is_vm_running() - checks if firecracker process is alive
  - sync_vm_state() - syncs config state with actual process state
- Added 6 unit tests for VmError and constants
- Commit: f83ce1e

### Task 9: Wire Daemon Handlers to VM Lifecycle Functions
- Updated daemon HTTP handlers to use actual VM lifecycle functions from vm module
- handle_create_vm() now calls vm::create_vm() instead of placeholder config creation
- handle_stop_vm() now calls vm::stop_vm() instead of just updating config state
- handle_start_vm() now calls vm::start_vm() instead of just updating config state
- handle_destroy_vm() now calls vm::destroy_vm() instead of just removing directory
- Added proper HTTP error mapping based on VmError variants:
  - VmError::NotFound -> 404
  - VmError::InvalidState -> 400
  - VmError::ResourceNotAvailable -> 503
  - Other errors -> 500
- Imported VmError type for error handling
- All 69 tests pass
- Commit: d3b4b17

### Task 10: Integrate Network Setup on Daemon Startup
- Added network module import to daemon.rs
- Call network::setup_network() in daemon's run() function before starting HTTP server
- Network setup creates fcm0 bridge, assigns 172.16.0.1 gateway IP, enables IP forwarding
- Sets up nftables masquerade for VM outbound traffic (NAT)
- Errors are handled gracefully with warning messages (doesn't block daemon startup)
- All 69 tests pass
- Commit: bf535d6

### Task 11: Base Rootfs Image Build Scripts
- Created rootfs/ directory for base image build files
- Created Dockerfile as specified in PRD:
  - Based on alpine:edge
  - Installs openssh, ruby, ruby-bundler, python3, py3-pip, curl, bash, iproute2
  - Configures SSH with root login enabled (root:root password)
  - Copies init script to /sbin/init
- Created init script for VM initialization:
  - Mounts essential filesystems (proc, sysfs, devtmpfs, devpts)
  - Creates necessary device nodes if missing
  - Sets hostname from kernel cmdline if available
  - Configures DNS (8.8.8.8, 8.8.4.4)
  - Starts sshd
  - Runs placeholder HTTP server on port 8000 using python3
  - Keeps init process running with bash login shell
- Created build.sh script to automate rootfs creation:
  - Builds Docker image from Dockerfile
  - Exports container filesystem to tarball
  - Creates sparse ext4 filesystem image (1GB apparent, ~400MB actual)
  - Extracts rootfs tarball into ext4 image
  - Outputs to /var/lib/firecracker/base-rootfs.img by default
- All 69 tests pass
- Commit: 30c52ca

### Task 12: Fix Init Script Hostname Parsing
- Fixed hostname parsing in rootfs/init script
- Init script was incorrectly looking for `hostname=` kernel argument
- Boot args actually pass hostname as 5th field of `ip=` parameter
- Format: `ip=<client-ip>:<server-ip>:<gw-ip>:<netmask>:<hostname>:<device>:<autoconf>`
- Example: `ip=172.16.0.50::172.16.0.1:255.255.255.0:myvm:eth0:on`
- Updated parsing logic to extract hostname from ip= parameter correctly
- Also fixed comment that incorrectly showed empty hostname field
- All 69 tests pass
- Commit: 8ac22cd

### Task 13: Fix VM Boot with Dropbear SSH and Entropy Initialization
- Fixed multiple issues preventing VMs from booting and running SSH correctly
- Updated src/firecracker.rs build_boot_args():
  - Added `init=/sbin/init root=/dev/vda rw` to kernel boot arguments
  - These parameters are required for the kernel to mount rootfs and run init
- Replaced OpenSSH with dropbear in rootfs/Dockerfile:
  - OpenSSH sshd caused init process to die when daemonizing (PID 1 issue)
  - Dropbear is lighter weight and works correctly in minimal VM environment
  - Pre-generates host keys during image build (RSA, ECDSA, ED25519)
- Added rng-tools package to rootfs/Dockerfile:
  - SSH was timing out during banner exchange due to uninitialized kernel RNG
  - rngd feeds entropy from /dev/urandom to /dev/random to initialize CRNG
- Complete rewrite of rootfs/init script:
  - Uses `mountpoint -q` to check if filesystems are already mounted (avoids errors)
  - Removed `set -e` to prevent init from dying on non-fatal errors
  - Starts rngd in background for entropy
  - Starts dropbear SSH server in foreground mode (`-R -F -E`)
  - Starts python3 HTTP server on port 8000 for testing
  - Improved logging to /var/log/init.log (also exposed via HTTP at /init.log)
- Tested full fcm workflow:
  - `fcm daemon` starts correctly, sets up fcm0 bridge
  - `fcm create` creates and starts VM
  - `fcm ls` lists running VMs with correct state
  - SSH works via `sshpass -p "root" ssh root@<vm-ip>`
  - `fcm stop`, `fcm start`, `fcm destroy` all work correctly
- All 69 tests pass
- Commit: c090b6c

### Task 14: Simplify fcm create with Better Defaults
- Removed --name CLI option - VMs now always get a random name (e.g., "cosmic-nova")
- Removed --expose CLI option - port 8000 is now always exposed by default
- Updated main.rs: simplified Create command with no arguments
- Updated client.rs: removed CreateVmRequest struct, simplified create_vm() function
- Updated daemon.rs: added DEFAULT_EXPOSE_PORT constant (8000), simplified handle_create_vm()
- Removed parse_json_body() function (no longer needed)
- Removed tests for CreateVmRequest serialization/deserialization
- Added test for DEFAULT_EXPOSE_PORT constant
- User experience is now simpler: just run `fcm create` with no options
- Random name is automatically used for the sslip.io domain
- All 66 tests pass
- Commit: 0c71ca5
- Fix: Domain now correctly uses VM name (e.g., nebula-tensor.64-34-93-45.sslip.io)
- Commit: 02a883b

### Task 15: Remove Unused Code to Eliminate Compiler Warnings
- Removed dead code across multiple modules to eliminate all 15 compiler warnings
- caddy.rs:
  - Removed ParseError variant from CaddyError enum
  - Removed is_running() function
  - Removed validate() and validate_file() functions
  - Updated test_caddy_error_display test
- firecracker.rs:
  - Removed InstanceInfo struct
  - Removed get() method
  - Removed get_instance_info() method
  - Removed test_instance_info_deserialization test
- network.rs:
  - Removed SUBNET_MASK and SUBNET_CIDR constants
  - Removed InvalidIp variant from NetworkError enum
  - Removed cleanup_network() function
  - Removed parse_last_octet() and is_valid_vm_ip() functions
  - Removed associated tests for deleted code
- vm.rs:
  - Removed load_by_id() method from VmConfig
  - Removed is_vm_running() function
  - Removed sync_vm_state() function
- All 59 tests pass with zero warnings
- Commit: c9bf4ad

### Task 16: Fix Clippy Warnings
- Fixed 3 clippy warnings for cleaner, more idiomatic Rust code
- client.rs: Embedded DOMAIN literal directly in format string instead of using `{}`
- daemon.rs: Removed useless `.into()` call for header.value.as_str() which already returns `&str`
- firecracker.rs: Replaced manual range check `status >= 200 && status < 300` with `(200..300).contains(&status)`
- All 59 tests pass with zero clippy warnings
- Commit: 733b018

### Task 17: SSH Public Key Injection for Passwordless VM Access
- Users with SSH keys can now SSH into VMs without entering a password
- client.rs:
  - Added find_ssh_public_key() to read user's SSH public key from ~/.ssh/
  - Tries id_ed25519.pub, id_ecdsa.pub, id_rsa.pub in order of preference
  - Sends key in CreateVmRequest JSON body when creating a VM
  - Shows warning if no SSH key found (password auth still works)
- daemon.rs:
  - Added CreateVmRequest struct with ssh_public_key field
  - Parses request body in handle_create_vm() and passes key to vm::create_vm()
- vm.rs:
  - Added inject_ssh_key() function that mounts rootfs and writes authorized_keys
  - Creates /root/.ssh directory with 700 permissions
  - Writes key to /root/.ssh/authorized_keys with 600 permissions
  - Updated create_vm() signature to accept optional ssh_public_key
  - Injects key after copying rootfs, before creating tap device
- All 61 tests pass with zero warnings
- Commit: 958aaa8

### Task 18: FCM_HOST Environment Variable for Remote Connections
- Added support for connecting to remote daemon via FCM_HOST env var
- client.rs:
  - Added daemon_url() function to get daemon URL from FCM_HOST or default
  - Supports both bare host:port (e.g., "192.168.1.100:7777") and full URLs
  - Automatically prepends "http://" if no scheme provided
  - Defaults to "http://127.0.0.1:7777" when FCM_HOST not set
  - Updated make_request() to use daemon_url() instead of hardcoded constant
  - Added 3 unit tests for daemon URL handling
- All 64 tests pass with zero warnings
- Commit: 4f12443

### Task 19: Bind Daemon to All Interfaces for External Access
- Changed BIND_ADDR from "127.0.0.1:7777" to "0.0.0.0:7777"
- Allows remote CLI clients to connect without SSH tunneling
- Token authentication still required for all requests
- Commit: e56a284

### Task 20: SSH ProxyJump for Remote Daemon Connections
- Fixed SSH failing when CLI runs on external machine (e.g., Mac connecting to remote server)
- Problem: `fcm ssh` tried to connect directly to VM's internal IP (172.16.0.x)
- Solution: Use SSH ProxyJump (-J) to tunnel through the daemon host
- client.rs:
  - Added get_jump_host() function to detect remote daemon and build jump host string
  - Extracts hostname from FCM_HOST (strips scheme and port)
  - Returns None for localhost/127.0.0.1 (no jump needed)
  - Uses current user ($USER) for jump host authentication
  - Updated ssh_vm() to add -J flag when connecting to remote daemon
  - Shows "Connecting via jump_host..." message for remote connections
  - Added 4 unit tests for get_jump_host() function
- All 68 tests pass with zero warnings
- Commit: a28be91

### Task 21: Session Management Module (session.rs)
- Created session.rs module for persistent console session management
- SessionError enum with Display impl for error handling:
  - NotFound, VmNotAvailable, SshError, TmuxError, Io variants
- SessionInfo struct for session metadata:
  - id: unique 6-char session ID
  - vm_id: VM the session belongs to
  - tmux_session: tmux session name (fcm-<id>)
  - created_at: creation timestamp
  - is_default: whether this is the default session for the VM
- SessionManager struct with thread-safe session tracking:
  - create_session(): creates tmux session on VM via SSH
  - get_session(): retrieves session info by ID
  - list_sessions(): lists all sessions for a VM
  - kill_session(): terminates tmux session on VM
  - remove_vm_sessions(): removes all sessions when VM is stopped/destroyed
  - sync_sessions(): syncs with actual tmux state on VM
- Helper functions:
  - generate_session_id(): generates 6-char alphanumeric IDs
  - create_tmux_session(): creates tmux session via SSH
  - list_tmux_sessions(): lists tmux sessions via SSH
  - kill_tmux_session(): kills tmux session via SSH
  - attach_to_session(): spawns SSH process attached to tmux session
- Added session module to main.rs
- 13 unit tests for session management functionality
- All 79 tests pass (single-threaded; 2 pre-existing test isolation issues with parallel env vars)
- Commit: b9eb527

### Task 22: Wire Session Endpoints to Daemon
- Wired session management endpoints to daemon HTTP server
- Added SessionResponse type for API responses (converts SessionInfo to JSON)
- Added CreateSessionRequest type with is_default field for session creation
- Imported session module into daemon.rs
- Created SessionManager instance in daemon's run() function
- Added three new handlers:
  - handle_create_session(): POST /vms/{id}/sessions - creates new tmux session
  - handle_list_sessions(): GET /vms/{id}/sessions - lists active sessions for a VM
  - handle_kill_session(): DELETE /vms/{id}/sessions/{session-id} - kills a session
- Refactored routing to use pattern matching on path parts (cleaner than if/else chains)
- Removed unused extract_vm_id() function (replaced by pattern matching)
- Updated tests: replaced test_extract_vm_id with test_session_response_from_info and test_create_session_request_default
- Removed module-level #![allow(dead_code)] from session.rs
- Added specific #[allow(dead_code)] attributes to items that will be used in future tasks
- All 80 tests pass with zero warnings
- Commit: 48a3093

### Task 23: Console Streaming Client Module (console.rs)
- Created console.rs module for client-side terminal streaming
- ConsoleError enum with variants: ConnectionFailed, AuthFailed, Io, TerminalError, SessionError
- ConnectRequest struct for authentication protocol:
  - vm: VM ID or name
  - session: session ID to connect to
  - token: auth token for daemon
- ConnectResponse struct for daemon response (success/error)
- terminal_host() function to extract hostname from FCM_HOST env var
- load_token() function to load auth token (FCM_TOKEN env or ~/.fcm-token)
- RawTerminal struct for terminal mode handling:
  - enable() puts terminal in raw mode using libc termios
  - restore() restores original terminal settings
  - Implements Drop trait for automatic cleanup
- is_tty() function to check if stdin is a terminal
- connect() main function:
  - Connects to daemon terminal server (port 7778)
  - Sends JSON authentication message
  - Reads response and validates success
  - Enters raw terminal mode
  - Spawns reader thread for socket->stdout proxying
  - Main thread handles stdin->socket proxying
  - Supports Ctrl+] (0x1d) to disconnect
  - Proper cleanup and terminal restoration on exit
- Added console module to main.rs
- Added #[allow(dead_code)] annotations for items used in future tasks
- 10 unit tests for serialization, deserialization, and helper functions
- All 89 tests pass with zero warnings
- Commit: 5d50657

### Task 24: Terminal Server on Port 7778 in Daemon
- Added terminal server TCP listener on port 7778 for persistent console sessions
- Terminal server runs in a separate thread alongside the HTTP server
- TerminalConnectRequest struct for client authentication protocol:
  - vm: VM ID or name
  - session: session ID to connect to
  - token: auth token for daemon
- TerminalConnectResponse struct for server responses (success/error)
- handle_terminal_connection() function:
  - Reads JSON connect request with newline delimiter
  - Validates auth token
  - Looks up VM and validates it's running
  - Looks up session and verifies it belongs to the VM
  - Spawns SSH process attached to tmux session using attach_to_session()
  - Sends success response, then proxies I/O
- send_terminal_error() and send_terminal_response() helpers
- proxy_terminal_io() function:
  - Spawns thread to read from child stdout and write to client
  - Main thread reads from client and writes to child stdin
  - Handles EOF and connection drops gracefully
- run_terminal_server() function:
  - Binds to 0.0.0.0:7778
  - Accepts connections in a loop
  - Spawns thread for each connection
- Updated daemon's run() to spawn terminal server thread
- 4 unit tests for terminal protocol types
- All 93 tests pass with zero warnings
- Commit: b1eaae8

### Task 25: Update CLI with console/sessions/attach Commands
- Added three new CLI commands in main.rs for persistent console sessions:
  - `fcm console <vm>` - opens persistent console session (creates default session)
  - `fcm sessions <vm>` - lists active sessions for a VM
  - `fcm attach <vm> <session-id>` - reattaches to an existing session
- Added client functions in client.rs:
  - console_vm() - creates session via POST /vms/{id}/sessions, then connects via console::connect()
  - list_sessions() - GET /vms/{id}/sessions with formatted table output
  - attach_session() - connects to existing session via console::connect()
- Added SessionResponse struct for deserializing session API responses
- Added format_timestamp() helper for human-readable relative times (e.g., "5m ago", "2h ago")
- Imported console module in client.rs for terminal streaming connection
- All 93 tests pass with zero warnings
- Commit: 2bdb7eb

### Task 26: Remove #[allow(dead_code)] Attributes from console.rs
- Removed 12 #[allow(dead_code)] annotations from console.rs
- Code is now used after Task 25 wired CLI commands
- Removed dead_code from:
  - DEFAULT_TERMINAL_PORT constant
  - ConsoleError enum
  - ConnectRequest struct
  - ConnectResponse struct
  - terminal_host() function
  - token_path() function
  - load_token() function
  - RawTerminal struct
  - RawTerminal::enable() method
  - RawTerminal::restore() method
  - is_tty() function
  - connect() function
- All 93 tests pass with zero warnings
- Commit: 21be38e
- Additional cleanup in session.rs:
  - Removed dead_code from get_session() - used in daemon.rs:550
  - Removed dead_code from attach_to_session() - used in daemon.rs:571
  - Updated comments on VmNotAvailable and SshError variants (still unused)
- Remaining legitimate dead_code annotations:
  - client.rs: vm_id field in SessionResponse (JSON completeness, not displayed)
  - session.rs: VmNotAvailable variant (matched but not constructed)
  - session.rs: SshError variant (matched but not constructed)
- Commit: cfb609d

### Task 27: Wire Session Cleanup to VM Stop/Destroy
- Sessions are now automatically cleaned up when a VM is stopped or destroyed
- Updated handle_stop_vm() in daemon.rs:
  - Added session_manager parameter
  - Calls remove_vm_sessions() after successfully stopping VM
- Updated handle_destroy_vm() in daemon.rs:
  - Added session_manager parameter
  - Calls remove_vm_sessions() after successfully destroying VM
- Updated routing in handle_request() to pass session_manager to:
  - handle_stop_vm() for POST /vms/{id}/stop
  - handle_destroy_vm() for DELETE /vms/{id}
- Removed #[allow(dead_code)] from remove_vm_sessions() in session.rs
- All 93 tests pass with zero warnings
- Commit: a1099a5

### Task 28: Fix Session SSH Authentication with sshpass
- Fixed session management SSH commands to use sshpass for password authentication
- The daemon uses SSH to create/list/kill tmux sessions on VMs
- VMs use root:root password auth, but session.rs was using plain ssh without credentials
- Updated all SSH functions in session.rs to use sshpass:
  - create_tmux_session(): creates tmux session on VM
  - list_tmux_sessions(): lists active tmux sessions on VM
  - kill_tmux_session(): terminates tmux session on VM
  - attach_to_session(): spawns SSH process attached to tmux session
- Fixed sync_sessions() bug:
  - Previously used unwrap_or_default() which returned empty Vec on SSH error
  - This caused all sessions to be removed when SSH temporarily failed
  - Now skips sync entirely if list_tmux_sessions() fails (preserves existing sessions)
- Tested all console commands:
  - `fcm sessions <vm>` - lists active sessions correctly
  - `fcm console <vm>` - creates session and connects (non-TTY error expected in test)
  - `fcm attach <vm> <session-id>` - attaches to existing session
- All 93 tests pass with zero warnings
- Commit: d78521c

### Task 29: Remove Legacy SSH Command (Not in PRD)
- The PRD specifies console/sessions/attach commands for VM access, not a bare ssh command
- With persistent console sessions fully implemented, the legacy ssh command is no longer needed
- main.rs:
  - Removed Ssh variant from Commands enum
  - Removed Commands::Ssh match arm
- client.rs:
  - Removed ssh_vm() function
  - Removed get_jump_host() function (only used by ssh_vm)
  - Removed SshInfoResponse struct
  - Removed std::process::Command import
  - Removed 5 related tests (ssh_info_deserialization, 4 get_jump_host tests)
- daemon.rs:
  - Removed SshInfoResponse struct
  - Removed handle_ssh_info() function
  - Removed /vms/{id}/ssh route from routing table
- All 88 tests pass with zero warnings
- Commit: 0a44c31

### Task 30: Add tmux to Base Rootfs Image
- PRD specifies tmux for persistent console sessions, but it was missing from Dockerfile
- rootfs/Dockerfile:
  - Added tmux to apk add package list
- Rebuilt base-rootfs.img with tmux included (145MB sparse)
- Tested with new VM (orbital-comet):
  - `fcm sessions` - correctly shows no sessions initially
  - `fcm console` - creates session successfully, connects to terminal server
  - `fcm attach` - attaches to existing session correctly
  - tmux session persists on VM (verified via direct SSH)
- All 88 tests pass with zero warnings
- Commit: e71ea59

### Task 31: macOS Cross-Compilation Script
- Created build-macos.sh script for cross-compiling fcm CLI to macOS
- Uses cargo-zigbuild with Zig as cross-linker (no macOS SDK required)
- Builds two targets:
  - aarch64-apple-darwin (Apple Silicon M1/M2/M3) - 2.5MB binary
  - x86_64-apple-darwin (Intel Mac) - 2.6MB binary
- Prerequisites: `cargo install cargo-zigbuild`, zig installed
- Usage: `./build-macos.sh`
- Outputs to target/<arch>-apple-darwin/release/fcm
- All 88 tests pass with zero warnings
- Commit: a87f4fc

### Task 32: Improve Console UX for Seamless Experience
- Improved console session persistence to match sprites.dev experience
- session.rs:
  - Added vm_session_name() for canonical session names (console-{vm_id})
  - Added get_or_create_console() method that:
    - Returns existing session if tracked in memory
    - Checks if tmux session exists on VM and registers it
    - Creates new tmux session only if needed
  - One session per VM instead of multiple sessions with IDs
  - Sessions survive client disconnects and daemon restarts
- daemon.rs:
  - Terminal handler now uses get_or_create_console() instead of get_session()
  - Auto-creates session if missing when client connects
- client.rs:
  - Removed session ID from console output
  - Cleaner UX: session details hidden from user
- console.rs:
  - Simplified output: "Connecting to <vm>..." instead of technical details
  - On detach: shows "Run 'fcm console <vm>' to reconnect"
  - Hide tmux implementation details completely
- Added test for vm_session_name()
- All 89 tests pass with zero warnings
- Commit: fe6eb83

### Task 33: Fix Tmux UX Issues
- Fixed tmux visual artifacts and sizing issues for cleaner experience
- session.rs:
  - Disable tmux status bar on session creation (`status off`)
  - Set `destroy-unattached off` to keep sessions alive
  - Resize tmux window to match client terminal before attaching
  - Separated session creation from option setting for reliability
- console.rs:
  - Added get_terminal_size() to detect client terminal dimensions
  - Send cols/rows in ConnectRequest to daemon
- daemon.rs:
  - Added cols/rows fields to TerminalConnectRequest
  - Pass terminal size to attach_to_session()
- Fixes:
  - No more tmux status bar at bottom
  - Terminal size matches client on connect
- All 89 tests pass with zero warnings
- Commit: fc088a3

### Task 34: Fix Session Attachment Bug
- Fixed bug where each connection created spurious tmux sessions (1, 2, 3...)
- Root cause: using `sh -c` with compound tmux commands caused extra sessions
- Solution: split into separate SSH calls for resize and attach
- Now correctly maintains single `console-{vm_id}` session per VM
- Multiple terminals connect to same session
- Session state persists across disconnects
- Commit: 7867c74

### Task 35: Remove Redundant sessions/attach Commands
- With single-session-per-VM model, sessions and attach commands became redundant
- Users only need `fcm console <vm>` to connect/reconnect to persistent session
- Removed from main.rs:
  - Sessions and Attach CLI command variants
  - Match arms for these commands
- Removed from client.rs:
  - list_sessions() and attach_session() functions
  - format_timestamp() helper
- Removed from daemon.rs:
  - GET /vms/{id}/sessions endpoint and handle_list_sessions() handler
  - DELETE /vms/{id}/sessions/{session-id} endpoint and handle_kill_session() handler
- Removed from session.rs:
  - list_sessions(), kill_session(), sync_sessions() methods
  - kill_tmux_session() helper function
  - test_session_manager_list_empty test
- Simplified CLI: now only 7 commands (create, ls, console, stop, start, destroy, daemon)
- All 88 tests pass with zero warnings
- Commit: 9b35d3a

### Task 36: Fix Session Recreation After User Exits Shell
- Bug: typing `exit` in console destroyed tmux session, but cached SessionInfo remained
- On reconnect, `get_or_create_console()` returned stale cached info without checking VM
- Result: "no sessions" error when trying to reconnect
- Fix: Always check if tmux session exists on VM before returning cached info
- If session was destroyed (user typed 'exit'), automatically recreate it
- All 88 tests pass with zero warnings
- Commit: 066296e

### Task 37: Procfile Deployment Support (Git Push Deployment)
- Implemented heroku-style git push deployment as specified in PRD
- Created git.rs module for git repository management:
  - repo_path(): returns path to VM's bare git repo at /root/<vm-name>.git
  - create_repo(): creates bare git repo with post-receive hook
  - delete_repo(): removes git repo when VM is destroyed
  - repo_exists(): checks if git repo exists for a VM
  - get_clone_url(): generates git clone URL for VM
  - generate_post_receive_hook(): creates hook that syncs code and runs deploy
- Post-receive hook functionality:
  - Checks out pushed code to temp directory
  - Syncs code to VM's /app directory via scp with sshpass
  - Runs fcm-deploy script on VM via ssh
  - Supports main and master branches
- Created fcm-deploy script (runs on VM):
  - Detects Ruby (Gemfile) and runs bundle install
  - Detects Python (requirements.txt) and runs pip install
  - Detects Node.js (package.json) and runs npm install
  - Parses Procfile for web process command
  - Starts/restarts web process using fcm-runner
- Created fcm-runner script (process manager on VM):
  - start/stop/restart/status commands
  - Manages PID file at /var/run/fcm-web.pid
  - Logs to /var/log/fcm-web.log
  - Exports PORT=8000 environment variable
- Updated vm.rs:
  - create_vm() now creates git repo after VM is running
  - destroy_vm() now deletes git repo when VM is destroyed
  - Added GitError variant to VmError enum
- Updated daemon.rs:
  - VmResponse now includes optional git_url field
  - Git URL is computed from VM name and server IP
- Updated client.rs:
  - VmResponse includes git_url field
  - print_vm() displays git URL when present
- Updated rootfs/Dockerfile:
  - Added nodejs and npm packages for Node.js apps
  - Added git package
  - Added fcm-deploy and fcm-runner scripts to /usr/local/bin
  - Created /app directory for deployments
- All 93 tests pass (single-threaded due to env var isolation)
- Commit: 6a3a3eb

### Task 38: Fix Git Deployment Issues Found During Testing
- Fixed issues discovered during end-to-end git deployment testing
- src/git.rs:
  - Added PATH export to post-receive hook (SSH sessions don't have system PATH)
  - Changed code sync from scp to tar-over-ssh (dropbear lacks sftp-server)
- rootfs/fcm-runner:
  - Added fuser -k to kill any process on PORT before starting
  - Prevents conflicts with old processes or init's default server
- rootfs/fcm-deploy:
  - Use full path /usr/local/bin/fcm-runner (not in PATH via SSH)
- rootfs/init:
  - Removed default HTTP server on port 8000 (conflicts with deployed apps)
  - Create /app directory for Procfile deployments at boot
- Tested full deployment flow:
  - `git push fcm master` syncs code and triggers deployment
  - Dependency detection works (Python, Ruby, Node.js)
  - Web process starts/restarts correctly on port 8000
  - Re-deployment properly stops old process before starting new one
- All 93 tests pass
- Commit: dfc771a

### Task 39: Add SSH Key to Host for Git Push Access
- Fixed git push requiring password by adding user's SSH key to host
- git.rs:
  - Added add_ssh_key_to_host() function
  - Creates /root/.ssh directory with 700 permissions if needed
  - Appends SSH public key to /root/.ssh/authorized_keys (600 permissions)
  - Avoids duplicate keys by checking existing entries
- daemon.rs:
  - Updated handle_create_vm() to call add_ssh_key_to_host() when SSH key provided
  - Key is added to host before VM creation proceeds
- Now when user runs `fcm create` with an SSH key:
  - Key is injected into VM's rootfs (for SSH into VM)
  - Key is added to host's authorized_keys (for git push to repo)
- All 94 tests pass
- Commit: 6ea98ab

### Task 40: Fix Git Push PATH Issue
- Fixed "git-receive-pack: command not found" error during git push
- Root cause: Non-interactive SSH sessions don't have PATH set
- Solution: Enable SSH user environment files
  - Set `PermitUserEnvironment yes` in /etc/ssh/sshd_config
  - Created /root/.ssh/environment with PATH
  - Restarted ssh service
- Git push now works without password using user's SSH key

### Task 41: Add GIT Column to ls Output
- Added GIT column to `fcm ls` command output
- Shows git repo address for each VM (e.g., root@64.34.93.45:vm-name.git)
- Makes it easy to find the correct remote URL for git push deployment
- Updated client.rs list_vms() function:
  - Added GIT to header row
  - Widened separator line to 120 chars
  - Added git_url field to each VM row
- All 94 tests pass with zero warnings
- Commit: 807f306

### Task 42: Improved Create Output with ASCII Art and Koans
- Redesigned `fcm create` output for better UX
- Added shaded ring ASCII art logo:
  - White ring with gray shading (░▒▓█)
  - Clean monochrome aesthetic
- Removed ID and IP from output (cleaner, less technical)
- Color scheme: gray comments, white commands, blue important values
- Added random zen koans displayed in index.html example:
  - "The code that is not written has no bugs."
  - "Before enlightenment: write code. After enlightenment: write code."
  - "What is the sound of one container crashing?"
  - ...and 9 more
- Added Quick Start section with step-by-step instructions:
  - git init
  - Create index.html with random koan
  - Create Procfile
  - Add remote and deploy
- All 94 tests pass with zero warnings
- Commits: 12d28b5, 8431fa0, 7ee5628, 281be7e, 3108f18, faee19b, 1879e09, bb7a1e8

### Task 43: Remove ID and IP from Command Output
- Simplified `fcm ls` table output to show only NAME, STATE, DOMAIN, GIT
- Removed ID and IP columns from list_vms() header and row output
- Updated print_vm() to remove ID, IP, and Port fields
- print_vm() now shows only Name, State, URL, and Git
- Added #[allow(dead_code)] to VmResponse fields still needed for JSON deserialization
- Adjusted column widths for cleaner table formatting
- All 94 tests pass with zero warnings
- Commit: f686a62

### Task 44: Fix Clippy Warning
- Fixed clippy::print_literal warning in list_vms()
- Embedded "GIT" literal directly in format string instead of passing as argument
- All 94 tests pass with zero clippy warnings
- Commit: 4283fcc

### Task 45: Add VCPU and Memory to ls and Create Output
- Added vcpu_count and mem_size_mib fields to VmConfig struct
- Used serde defaults so existing VMs get default values (1 vCPU, 512MB)
- Updated VmResponse in both daemon.rs and client.rs
- Updated list_vms() to show VCPU and MEMORY columns in table
- Updated print_vm() to display vCPU and Memory for stop/start/create output
- All 94 tests pass with zero warnings
- Commit: 5666774

### Task 46: Add Disk Space to ls and Create Output
- Added disk_used_mb() method to VmConfig using `du -m` for actual disk usage
- Added disk_max_mb() method using file metadata for apparent/max size
- Handles sparse files correctly (shows actual vs apparent size)
- Updated VmResponse to include both disk_used_mb and disk_max_mb
- Display format: "202MB/1024MB" (used/max)
- Updated list_vms() and print_vm() to show disk in used/max format
- All 94 tests pass with zero warnings
- Commits: 27bc32f, 5832b10

### Task 47: Show Deploy Success and URL After Git Push
- Updated post-receive hook to display deployment status and project URL
- On successful deploy: shows "-----> Deploy successful!" and the https URL
- On failed deploy: shows "-----> Deploy failed!" and exits with error
- Passed domain parameter to generate_post_receive_hook() for URL generation
- Updated create_repo() in git.rs to accept domain parameter
- Updated vm.rs to pass domain from expose config to git repo creation
- Suppressed SSH stderr noise in hook for cleaner output
- Updated test to verify new hook functionality
- All 94 tests pass with zero warnings
- Commit: a3a16e8

### Task 48: Stream Startup Logs in Git Push Output
- Added "Startup logs:" section to git push output
- Shows tail of /var/log/fcm-web.log after deployment
- On success: shows last 20 lines of startup logs
- On failure: shows last 30 lines to help debug errors
- Helps debug issues like gunicorn startup failures
- Refactored hook to use ssh_cmd() helper function
- All 94 tests pass with zero warnings
- Commit: f68a8d3

### Task 49: Fix pip install and PATH Issues for Python Deployments
- Fixed "gunicorn: not found" error during Python app deployment
- Root cause: Alpine Linux with Python 3.11+ requires --break-system-packages flag (PEP 668)
- rootfs/fcm-deploy:
  - Added --break-system-packages flag to pip3 install command
  - Without this flag, pip install silently fails on externally managed Python
- rootfs/fcm-runner:
  - Added PATH export to include /usr/local/bin:/usr/bin:/bin
  - Ensures pip-installed binaries (like gunicorn) are found when starting web process
- Rebuilt base-rootfs.img with updated scripts
- Updated scripts on existing VM (arctic-eclipse) for immediate fix
- All 94 tests pass with zero warnings
- Commit: 581a15b

### Task 50: Change Git Remote Name from fcm to origin
- Changed Quick Start instructions to use "origin" instead of "fcm"
- Users can now use default git commands: `git push origin main` or just `git push`
- Updated client.rs create_vm() output
- All 94 tests pass with zero warnings
- Commit: 81b3d4b

### Task 51: Fix Ruby Deployment with Native Gem Compilation
- Fixed "bundler: command not found: puma" error during Rails app deployment
- Root cause: Ruby gems with native extensions (puma, nokogiri, etc.) require build tools
- rootfs/Dockerfile:
  - Added build-base for gcc, make, etc.
  - Added ruby-dev for Ruby headers
  - Added libffi-dev, yaml-dev, zlib-dev, openssl-dev for common gem dependencies
- rootfs/fcm-deploy:
  - Changed bundle install to use local path (vendor/bundle) for isolation
  - Added config to exclude development and test groups
  - Show tail of install log on failures for debugging
- Rebuilt base-rootfs.img with build dependencies (512MB sparse)
- All 94 tests pass with zero warnings
- Commit: ad75f97

### Task 52: Increase Default VM Resources for Rails Deployment
- Fixed out-of-memory errors during Ruby gem compilation (bigdecimal, etc.)
- src/vm.rs:
  - Increased DEFAULT_MEM_SIZE_MIB from 512 to 1024
  - Updated test to match new default
- rootfs/build.sh:
  - Increased IMAGE_SIZE_MB from 1024 to 2048 (2GB disk)
  - Rails apps with bundled gems need more disk space
- rootfs/init:
  - Added automatic 512MB swap file creation on boot
  - Helps with memory-intensive operations like gem compilation
- New VMs now have: 1024MB RAM, 2GB disk, 512MB swap
- All 94 tests pass with zero warnings
- Commit: 2d40f52

### Task 53: Fix Rails Production Deployment Issues
- Fixed multiple issues preventing Rails apps from starting in production
- rootfs/fcm-runner:
  - Added RAILS_ENV=production, RACK_ENV=production, NODE_ENV=production
  - Added automatic SECRET_KEY_BASE generation (required for Rails production)
- rootfs/Dockerfile:
  - Added tzdata package (Rails needs timezone data)
  - Added sqlite-dev and postgresql-dev for database gem compilation
- Rebuilt base-rootfs.img with all fixes
- Successfully tested Rails 8.1 app deployment
- All 94 tests pass with zero warnings
- Commit: 760a042

### Task 54: Update CLI Description
- Changed "Simple Firecracker VM manager" to "Firecracker VM manager"
- Updated #[command(about = ...)] in src/main.rs
- All 94 tests pass with zero warnings
- Commit: 987453d

### Task 55: Add ASCII Art Logo to CLI
- Added big block letter "FCM" with gradient shading (░▒▓█)
- Uses clap's before_help attribute to display logo above help text
- All 94 tests pass with zero warnings
- Commit: df0db0a

### Task 56: Local .fcm Config File for Project-Linked VMs
- Added local config file support to link project directories to VMs
- When running `fcm` without arguments:
  - If .fcm file exists, shows VM info (name, state, URL, git, vCPU, memory, disk)
  - If no .fcm file, shows error message with help hint
- client.rs:
  - Added LocalConfig struct with name, url, git fields
  - Added save_local_config() to write .fcm to current directory
  - Added load_local_config() to read .fcm from current directory
  - Added show_local_vm() to display VM info from local config
  - Fetches live VM state from daemon if available
  - Shows helpful commands (fcm console, git push)
- main.rs:
  - Made Commands subcommand optional (Option<Commands>)
  - When no command given, calls show_local_vm()
- create_vm() now saves .fcm file after successful VM creation
- Added 3 unit tests for LocalConfig serialization/deserialization
- All 97 tests pass with zero warnings
- Commit: 7b34ae0

### Task 57: Show Help Directly When No .fcm File Exists
- Changed behavior when running `fcm` without arguments and no .fcm file present
- Previously: showed error message telling user to run `fcm --help`
- Now: displays help output directly using clap's CommandFactory trait
- main.rs:
  - Added CommandFactory import from clap
  - Changed error handler to call `Cli::command().print_help()` instead of error message
  - Removed exit(1) since showing help is not an error condition
- All 97 tests pass with zero warnings
- Commit: c9ccbda

## Next Tasks
- None - all PRD features implemented
