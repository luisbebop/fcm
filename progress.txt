# FCM Implementation Progress

## Completed Tasks

### Task 1: Project Structure and CLI Parsing
- Created Cargo.toml with dependencies (clap, serde, serde_json, rand, tiny_http, ureq)
- Created src/main.rs with full CLI parsing using clap derive
- Commands implemented: create, ls, ssh, stop, start, destroy, daemon
- Created stub modules: client.rs, daemon.rs, vm.rs, firecracker.rs, network.rs, caddy.rs
- All modules compile, tests pass
- Commit: 4e93d71

### Task 2: VM Config Types and Name Generation
- Implemented VmConfig struct with id, name, ip, state, expose fields
- Implemented VmState enum (Running, Stopped)
- Implemented ExposeConfig struct for port/domain exposure
- Added word lists (ADJECTIVES, NOUNS) per PRD spec
- Implemented generate_id() for 8-char alphanumeric IDs
- Implemented random_name() for adjective-noun combinations
- Added helper methods: dir(), config_path(), rootfs_path(), socket_path(), pid_path()
- Added save() and load() methods for config persistence
- Added list_vms() and find_vm() functions for VM discovery
- Added 9 unit tests covering all functionality
- Commit: a3c8601

### Task 3: Daemon HTTP Server
- Implemented HTTP server on localhost:7777 using tiny_http
- Token-based authentication with Bearer header validation
- Auto-generates 32-char token on first run, saves to /var/lib/firecracker/.token
- Token file has restricted permissions (0600)
- REST API routes implemented:
  - POST /vms - create VM (saves config to disk)
  - GET /vms - list all VMs
  - GET /vms/{id} - get VM details
  - GET /vms/{id}/ssh - get SSH connection info
  - POST /vms/{id}/stop - stop VM
  - POST /vms/{id}/start - start VM
  - DELETE /vms/{id} - destroy VM (removes directory)
- JSON request/response handling with proper error responses
- Root check warning on startup
- Added 7 unit tests for token generation, routing, and serialization
- Added libc dependency for euid check
- Commit: 614b86b

### Task 4: Client HTTP Requests with Token Auth
- Implemented HTTP client using ureq with json feature
- Token loading from FCM_TOKEN env var or ~/.fcm-token file
- Added dirs dependency for cross-platform home directory detection
- make_request() helper for authenticated requests to daemon
- Implemented all client functions:
  - create_vm() - POST /vms with name/expose options
  - list_vms() - GET /vms with formatted table output
  - ssh_vm() - GET /vms/{id}/ssh then exec ssh command
  - stop_vm() - POST /vms/{id}/stop
  - start_vm() - POST /vms/{id}/start
  - destroy_vm() - DELETE /vms/{id}
- Proper error handling for connection failures and HTTP errors
- Added 8 unit tests for serialization, deserialization, and token loading
- Commit: 2c8a1c9

### Task 5: Firecracker API over Unix Socket
- Implemented FirecrackerClient struct for unix socket communication
- HTTP over unix socket with request/response parsing
- Request types: BootSource, Drive, MachineConfig, NetworkInterface
- Action types: InstanceStart, SendCtrlAltDel for VM control
- API methods:
  - set_boot_source() - configure kernel and boot args
  - set_drive() - configure rootfs drive
  - set_machine_config() - configure vcpu count and memory
  - set_network_interface() - configure network interface with MAC
  - start_instance() - start the VM
  - send_ctrl_alt_del() - graceful shutdown
  - get_instance_info() - get VM status
  - is_available() - check socket connectivity
- Helper functions: generate_mac(), build_boot_args()
- FirecrackerError enum with Display impl for error handling
- Added 17 unit tests for serialization, parsing, and helpers
- Commit: f505e61

### Task 6: Network Setup (Tap Devices and IP Allocation)
- Implemented NetworkError enum with Display impl for error handling
- Network constants: GATEWAY (172.16.0.1), SUBNET_MASK, SUBNET_CIDR
- IP allocation from pool (172.16.0.50-254)
- Tap device management:
  - tap_name() - generates tap device name (tap_<vm_id>)
  - create_tap() - creates tap device, brings it up, adds to bridge
  - delete_tap() - removes tap device
- Network bridge setup:
  - setup_network() - creates fcm0 bridge, assigns gateway IP, enables forwarding
  - cleanup_network() - removes bridge and nftables rules
- nftables masquerade setup for NAT (allows VMs to access internet)
- Helper functions:
  - allocate_ip() - finds first available IP in pool
  - get_used_ips() - gets IPs currently in use by VMs
  - parse_last_octet() - parses last octet from IP string
  - is_valid_vm_ip() - validates IP is in VM range
- Added 12 unit tests covering all functionality
- Commit: 670e9c5

### Task 7: Caddy Config Management
- Implemented CaddyError enum with Display impl for error handling
- Added CADDYFILE_PATH constant (/etc/caddy/Caddyfile)
- Server IP detection:
  - get_server_ip() - fetches public IP via ifconfig.me or icanhazip.com
  - is_valid_ipv4() - validates IPv4 address format
- Domain generation:
  - generate_domain() - creates sslip.io domain (e.g., myvm.64-34-93-45.sslip.io)
- Caddyfile management:
  - add_site() / add_site_to_file() - adds reverse proxy block to Caddyfile
  - remove_site() / remove_site_from_file() - removes managed block from Caddyfile
  - generate_caddy_block() - generates Caddy config block with fcm-managed marker
  - remove_site_block() - parses and removes site block using brace counting
  - update_site_in_file() - updates existing site configuration
- Caddy control:
  - reload() - reloads Caddy via systemctl or caddy CLI
  - is_running() - checks if Caddy service is active
  - validate() / validate_file() - validates Caddyfile syntax
- Added tempfile dev-dependency for tests
- Added 12 unit tests covering all functionality
- Commit: 44ac827

### Task 8: VM Lifecycle Management
- Implemented VmError enum that unifies errors from all modules (IO, Network, Firecracker, Caddy)
- Added From implementations for error conversion from all module error types
- Added constants: KERNEL_PATH, BASE_ROOTFS_PATH, DEFAULT_VCPU_COUNT (1), DEFAULT_MEM_SIZE_MIB (512)
- Implemented create_vm():
  - Checks for required kernel and rootfs files
  - Allocates IP from pool via network module
  - Creates VM directory and copies rootfs with sparse support (cp --sparse=always)
  - Creates tap device and adds to bridge
  - Spawns firecracker process
  - Waits for socket availability with configurable timeout
  - Configures boot source, drive, machine config, network interface via Firecracker API
  - Starts the VM instance
  - Configures Caddy if port exposure requested
  - Proper cleanup on any failure (removes directory, tap device, kills process)
- Implemented stop_vm():
  - Validates VM exists and is running
  - Attempts graceful shutdown via Ctrl+Alt+Del
  - Kills firecracker process (SIGTERM then SIGKILL)
  - Deletes tap device
  - Updates VM state to Stopped
- Implemented start_vm():
  - Validates VM exists and is stopped
  - Creates tap device
  - Spawns and configures new firecracker process
  - Starts the VM instance
  - Updates VM state to Running
- Implemented destroy_vm():
  - Stops VM if running (graceful then forced)
  - Deletes tap device
  - Removes Caddy site configuration if exposed
  - Removes VM directory completely
- Helper functions:
  - spawn_firecracker() - spawns firecracker process with API socket
  - kill_firecracker() - kills process by PID from file
  - wait_for_socket() - polls for socket availability with timeout
  - cleanup_failed_vm() - cleanup helper for create failures
  - is_vm_running() - checks if firecracker process is alive
  - sync_vm_state() - syncs config state with actual process state
- Added 6 unit tests for VmError and constants
- Commit: f83ce1e

### Task 9: Wire Daemon Handlers to VM Lifecycle Functions
- Updated daemon HTTP handlers to use actual VM lifecycle functions from vm module
- handle_create_vm() now calls vm::create_vm() instead of placeholder config creation
- handle_stop_vm() now calls vm::stop_vm() instead of just updating config state
- handle_start_vm() now calls vm::start_vm() instead of just updating config state
- handle_destroy_vm() now calls vm::destroy_vm() instead of just removing directory
- Added proper HTTP error mapping based on VmError variants:
  - VmError::NotFound -> 404
  - VmError::InvalidState -> 400
  - VmError::ResourceNotAvailable -> 503
  - Other errors -> 500
- Imported VmError type for error handling
- All 69 tests pass
- Commit: d3b4b17

### Task 10: Integrate Network Setup on Daemon Startup
- Added network module import to daemon.rs
- Call network::setup_network() in daemon's run() function before starting HTTP server
- Network setup creates fcm0 bridge, assigns 172.16.0.1 gateway IP, enables IP forwarding
- Sets up nftables masquerade for VM outbound traffic (NAT)
- Errors are handled gracefully with warning messages (doesn't block daemon startup)
- All 69 tests pass
- Commit: bf535d6

### Task 11: Base Rootfs Image Build Scripts
- Created rootfs/ directory for base image build files
- Created Dockerfile as specified in PRD:
  - Based on alpine:edge
  - Installs openssh, ruby, ruby-bundler, python3, py3-pip, curl, bash, iproute2
  - Configures SSH with root login enabled (root:root password)
  - Copies init script to /sbin/init
- Created init script for VM initialization:
  - Mounts essential filesystems (proc, sysfs, devtmpfs, devpts)
  - Creates necessary device nodes if missing
  - Sets hostname from kernel cmdline if available
  - Configures DNS (8.8.8.8, 8.8.4.4)
  - Starts sshd
  - Runs placeholder HTTP server on port 8000 using python3
  - Keeps init process running with bash login shell
- Created build.sh script to automate rootfs creation:
  - Builds Docker image from Dockerfile
  - Exports container filesystem to tarball
  - Creates sparse ext4 filesystem image (1GB apparent, ~400MB actual)
  - Extracts rootfs tarball into ext4 image
  - Outputs to /var/lib/firecracker/base-rootfs.img by default
- All 69 tests pass
- Commit: 30c52ca

### Task 12: Fix Init Script Hostname Parsing
- Fixed hostname parsing in rootfs/init script
- Init script was incorrectly looking for `hostname=` kernel argument
- Boot args actually pass hostname as 5th field of `ip=` parameter
- Format: `ip=<client-ip>:<server-ip>:<gw-ip>:<netmask>:<hostname>:<device>:<autoconf>`
- Example: `ip=172.16.0.50::172.16.0.1:255.255.255.0:myvm:eth0:on`
- Updated parsing logic to extract hostname from ip= parameter correctly
- Also fixed comment that incorrectly showed empty hostname field
- All 69 tests pass
- Commit: 8ac22cd

### Task 13: Fix VM Boot with Dropbear SSH and Entropy Initialization
- Fixed multiple issues preventing VMs from booting and running SSH correctly
- Updated src/firecracker.rs build_boot_args():
  - Added `init=/sbin/init root=/dev/vda rw` to kernel boot arguments
  - These parameters are required for the kernel to mount rootfs and run init
- Replaced OpenSSH with dropbear in rootfs/Dockerfile:
  - OpenSSH sshd caused init process to die when daemonizing (PID 1 issue)
  - Dropbear is lighter weight and works correctly in minimal VM environment
  - Pre-generates host keys during image build (RSA, ECDSA, ED25519)
- Added rng-tools package to rootfs/Dockerfile:
  - SSH was timing out during banner exchange due to uninitialized kernel RNG
  - rngd feeds entropy from /dev/urandom to /dev/random to initialize CRNG
- Complete rewrite of rootfs/init script:
  - Uses `mountpoint -q` to check if filesystems are already mounted (avoids errors)
  - Removed `set -e` to prevent init from dying on non-fatal errors
  - Starts rngd in background for entropy
  - Starts dropbear SSH server in foreground mode (`-R -F -E`)
  - Starts python3 HTTP server on port 8000 for testing
  - Improved logging to /var/log/init.log (also exposed via HTTP at /init.log)
- Tested full fcm workflow:
  - `fcm daemon` starts correctly, sets up fcm0 bridge
  - `fcm create` creates and starts VM
  - `fcm ls` lists running VMs with correct state
  - SSH works via `sshpass -p "root" ssh root@<vm-ip>`
  - `fcm stop`, `fcm start`, `fcm destroy` all work correctly
- All 69 tests pass
- Commit: c090b6c

### Task 14: Simplify fcm create with Better Defaults
- Removed --name CLI option - VMs now always get a random name (e.g., "cosmic-nova")
- Removed --expose CLI option - port 8000 is now always exposed by default
- Updated main.rs: simplified Create command with no arguments
- Updated client.rs: removed CreateVmRequest struct, simplified create_vm() function
- Updated daemon.rs: added DEFAULT_EXPOSE_PORT constant (8000), simplified handle_create_vm()
- Removed parse_json_body() function (no longer needed)
- Removed tests for CreateVmRequest serialization/deserialization
- Added test for DEFAULT_EXPOSE_PORT constant
- User experience is now simpler: just run `fcm create` with no options
- Random name is automatically used for the sslip.io domain
- All 66 tests pass
- Commit: 0c71ca5
- Fix: Domain now correctly uses VM name (e.g., nebula-tensor.64-34-93-45.sslip.io)
- Commit: 02a883b

### Task 15: Remove Unused Code to Eliminate Compiler Warnings
- Removed dead code across multiple modules to eliminate all 15 compiler warnings
- caddy.rs:
  - Removed ParseError variant from CaddyError enum
  - Removed is_running() function
  - Removed validate() and validate_file() functions
  - Updated test_caddy_error_display test
- firecracker.rs:
  - Removed InstanceInfo struct
  - Removed get() method
  - Removed get_instance_info() method
  - Removed test_instance_info_deserialization test
- network.rs:
  - Removed SUBNET_MASK and SUBNET_CIDR constants
  - Removed InvalidIp variant from NetworkError enum
  - Removed cleanup_network() function
  - Removed parse_last_octet() and is_valid_vm_ip() functions
  - Removed associated tests for deleted code
- vm.rs:
  - Removed load_by_id() method from VmConfig
  - Removed is_vm_running() function
  - Removed sync_vm_state() function
- All 59 tests pass with zero warnings
- Commit: c9bf4ad

### Task 16: Fix Clippy Warnings
- Fixed 3 clippy warnings for cleaner, more idiomatic Rust code
- client.rs: Embedded DOMAIN literal directly in format string instead of using `{}`
- daemon.rs: Removed useless `.into()` call for header.value.as_str() which already returns `&str`
- firecracker.rs: Replaced manual range check `status >= 200 && status < 300` with `(200..300).contains(&status)`
- All 59 tests pass with zero clippy warnings
- Commit: 733b018

### Task 17: SSH Public Key Injection for Passwordless VM Access
- Users with SSH keys can now SSH into VMs without entering a password
- client.rs:
  - Added find_ssh_public_key() to read user's SSH public key from ~/.ssh/
  - Tries id_ed25519.pub, id_ecdsa.pub, id_rsa.pub in order of preference
  - Sends key in CreateVmRequest JSON body when creating a VM
  - Shows warning if no SSH key found (password auth still works)
- daemon.rs:
  - Added CreateVmRequest struct with ssh_public_key field
  - Parses request body in handle_create_vm() and passes key to vm::create_vm()
- vm.rs:
  - Added inject_ssh_key() function that mounts rootfs and writes authorized_keys
  - Creates /root/.ssh directory with 700 permissions
  - Writes key to /root/.ssh/authorized_keys with 600 permissions
  - Updated create_vm() signature to accept optional ssh_public_key
  - Injects key after copying rootfs, before creating tap device
- All 61 tests pass with zero warnings
- Commit: 958aaa8

### Task 18: FCM_HOST Environment Variable for Remote Connections
- Added support for connecting to remote daemon via FCM_HOST env var
- client.rs:
  - Added daemon_url() function to get daemon URL from FCM_HOST or default
  - Supports both bare host:port (e.g., "192.168.1.100:7777") and full URLs
  - Automatically prepends "http://" if no scheme provided
  - Defaults to "http://127.0.0.1:7777" when FCM_HOST not set
  - Updated make_request() to use daemon_url() instead of hardcoded constant
  - Added 3 unit tests for daemon URL handling
- All 64 tests pass with zero warnings
- Commit: 4f12443

### Task 19: Bind Daemon to All Interfaces for External Access
- Changed BIND_ADDR from "127.0.0.1:7777" to "0.0.0.0:7777"
- Allows remote CLI clients to connect without SSH tunneling
- Token authentication still required for all requests
- Commit: e56a284

### Task 20: SSH ProxyJump for Remote Daemon Connections
- Fixed SSH failing when CLI runs on external machine (e.g., Mac connecting to remote server)
- Problem: `fcm ssh` tried to connect directly to VM's internal IP (172.16.0.x)
- Solution: Use SSH ProxyJump (-J) to tunnel through the daemon host
- client.rs:
  - Added get_jump_host() function to detect remote daemon and build jump host string
  - Extracts hostname from FCM_HOST (strips scheme and port)
  - Returns None for localhost/127.0.0.1 (no jump needed)
  - Uses current user ($USER) for jump host authentication
  - Updated ssh_vm() to add -J flag when connecting to remote daemon
  - Shows "Connecting via jump_host..." message for remote connections
  - Added 4 unit tests for get_jump_host() function
- All 68 tests pass with zero warnings
- Commit: a28be91

### Task 21: Session Management Module (session.rs)
- Created session.rs module for persistent console session management
- SessionError enum with Display impl for error handling:
  - NotFound, VmNotAvailable, SshError, TmuxError, Io variants
- SessionInfo struct for session metadata:
  - id: unique 6-char session ID
  - vm_id: VM the session belongs to
  - tmux_session: tmux session name (fcm-<id>)
  - created_at: creation timestamp
  - is_default: whether this is the default session for the VM
- SessionManager struct with thread-safe session tracking:
  - create_session(): creates tmux session on VM via SSH
  - get_session(): retrieves session info by ID
  - list_sessions(): lists all sessions for a VM
  - kill_session(): terminates tmux session on VM
  - remove_vm_sessions(): removes all sessions when VM is stopped/destroyed
  - sync_sessions(): syncs with actual tmux state on VM
- Helper functions:
  - generate_session_id(): generates 6-char alphanumeric IDs
  - create_tmux_session(): creates tmux session via SSH
  - list_tmux_sessions(): lists tmux sessions via SSH
  - kill_tmux_session(): kills tmux session via SSH
  - attach_to_session(): spawns SSH process attached to tmux session
- Added session module to main.rs
- 13 unit tests for session management functionality
- All 79 tests pass (single-threaded; 2 pre-existing test isolation issues with parallel env vars)
- Commit: b9eb527

### Task 22: Wire Session Endpoints to Daemon
- Wired session management endpoints to daemon HTTP server
- Added SessionResponse type for API responses (converts SessionInfo to JSON)
- Added CreateSessionRequest type with is_default field for session creation
- Imported session module into daemon.rs
- Created SessionManager instance in daemon's run() function
- Added three new handlers:
  - handle_create_session(): POST /vms/{id}/sessions - creates new tmux session
  - handle_list_sessions(): GET /vms/{id}/sessions - lists active sessions for a VM
  - handle_kill_session(): DELETE /vms/{id}/sessions/{session-id} - kills a session
- Refactored routing to use pattern matching on path parts (cleaner than if/else chains)
- Removed unused extract_vm_id() function (replaced by pattern matching)
- Updated tests: replaced test_extract_vm_id with test_session_response_from_info and test_create_session_request_default
- Removed module-level #![allow(dead_code)] from session.rs
- Added specific #[allow(dead_code)] attributes to items that will be used in future tasks
- All 80 tests pass with zero warnings
- Commit: 48a3093

### Task 23: Console Streaming Client Module (console.rs)
- Created console.rs module for client-side terminal streaming
- ConsoleError enum with variants: ConnectionFailed, AuthFailed, Io, TerminalError, SessionError
- ConnectRequest struct for authentication protocol:
  - vm: VM ID or name
  - session: session ID to connect to
  - token: auth token for daemon
- ConnectResponse struct for daemon response (success/error)
- terminal_host() function to extract hostname from FCM_HOST env var
- load_token() function to load auth token (FCM_TOKEN env or ~/.fcm-token)
- RawTerminal struct for terminal mode handling:
  - enable() puts terminal in raw mode using libc termios
  - restore() restores original terminal settings
  - Implements Drop trait for automatic cleanup
- is_tty() function to check if stdin is a terminal
- connect() main function:
  - Connects to daemon terminal server (port 7778)
  - Sends JSON authentication message
  - Reads response and validates success
  - Enters raw terminal mode
  - Spawns reader thread for socket->stdout proxying
  - Main thread handles stdin->socket proxying
  - Supports Ctrl+] (0x1d) to disconnect
  - Proper cleanup and terminal restoration on exit
- Added console module to main.rs
- Added #[allow(dead_code)] annotations for items used in future tasks
- 10 unit tests for serialization, deserialization, and helper functions
- All 89 tests pass with zero warnings
- Commit: 5d50657

### Task 24: Terminal Server on Port 7778 in Daemon
- Added terminal server TCP listener on port 7778 for persistent console sessions
- Terminal server runs in a separate thread alongside the HTTP server
- TerminalConnectRequest struct for client authentication protocol:
  - vm: VM ID or name
  - session: session ID to connect to
  - token: auth token for daemon
- TerminalConnectResponse struct for server responses (success/error)
- handle_terminal_connection() function:
  - Reads JSON connect request with newline delimiter
  - Validates auth token
  - Looks up VM and validates it's running
  - Looks up session and verifies it belongs to the VM
  - Spawns SSH process attached to tmux session using attach_to_session()
  - Sends success response, then proxies I/O
- send_terminal_error() and send_terminal_response() helpers
- proxy_terminal_io() function:
  - Spawns thread to read from child stdout and write to client
  - Main thread reads from client and writes to child stdin
  - Handles EOF and connection drops gracefully
- run_terminal_server() function:
  - Binds to 0.0.0.0:7778
  - Accepts connections in a loop
  - Spawns thread for each connection
- Updated daemon's run() to spawn terminal server thread
- 4 unit tests for terminal protocol types
- All 93 tests pass with zero warnings
- Commit: b1eaae8

### Task 25: Update CLI with console/sessions/attach Commands
- Added three new CLI commands in main.rs for persistent console sessions:
  - `fcm console <vm>` - opens persistent console session (creates default session)
  - `fcm sessions <vm>` - lists active sessions for a VM
  - `fcm attach <vm> <session-id>` - reattaches to an existing session
- Added client functions in client.rs:
  - console_vm() - creates session via POST /vms/{id}/sessions, then connects via console::connect()
  - list_sessions() - GET /vms/{id}/sessions with formatted table output
  - attach_session() - connects to existing session via console::connect()
- Added SessionResponse struct for deserializing session API responses
- Added format_timestamp() helper for human-readable relative times (e.g., "5m ago", "2h ago")
- Imported console module in client.rs for terminal streaming connection
- All 93 tests pass with zero warnings
- Commit: 2bdb7eb

### Task 26: Remove #[allow(dead_code)] Attributes from console.rs
- Removed 12 #[allow(dead_code)] annotations from console.rs
- Code is now used after Task 25 wired CLI commands
- Removed dead_code from:
  - DEFAULT_TERMINAL_PORT constant
  - ConsoleError enum
  - ConnectRequest struct
  - ConnectResponse struct
  - terminal_host() function
  - token_path() function
  - load_token() function
  - RawTerminal struct
  - RawTerminal::enable() method
  - RawTerminal::restore() method
  - is_tty() function
  - connect() function
- All 93 tests pass with zero warnings
- Commit: 21be38e
- Additional cleanup in session.rs:
  - Removed dead_code from get_session() - used in daemon.rs:550
  - Removed dead_code from attach_to_session() - used in daemon.rs:571
  - Updated comments on VmNotAvailable and SshError variants (still unused)
- Remaining legitimate dead_code annotations:
  - client.rs: vm_id field in SessionResponse (JSON completeness, not displayed)
  - session.rs: VmNotAvailable variant (matched but not constructed)
  - session.rs: SshError variant (matched but not constructed)
- Commit: cfb609d

### Task 27: Wire Session Cleanup to VM Stop/Destroy
- Sessions are now automatically cleaned up when a VM is stopped or destroyed
- Updated handle_stop_vm() in daemon.rs:
  - Added session_manager parameter
  - Calls remove_vm_sessions() after successfully stopping VM
- Updated handle_destroy_vm() in daemon.rs:
  - Added session_manager parameter
  - Calls remove_vm_sessions() after successfully destroying VM
- Updated routing in handle_request() to pass session_manager to:
  - handle_stop_vm() for POST /vms/{id}/stop
  - handle_destroy_vm() for DELETE /vms/{id}
- Removed #[allow(dead_code)] from remove_vm_sessions() in session.rs
- All 93 tests pass with zero warnings
- Commit: a1099a5

### Task 28: Fix Session SSH Authentication with sshpass
- Fixed session management SSH commands to use sshpass for password authentication
- The daemon uses SSH to create/list/kill tmux sessions on VMs
- VMs use root:root password auth, but session.rs was using plain ssh without credentials
- Updated all SSH functions in session.rs to use sshpass:
  - create_tmux_session(): creates tmux session on VM
  - list_tmux_sessions(): lists active tmux sessions on VM
  - kill_tmux_session(): terminates tmux session on VM
  - attach_to_session(): spawns SSH process attached to tmux session
- Fixed sync_sessions() bug:
  - Previously used unwrap_or_default() which returned empty Vec on SSH error
  - This caused all sessions to be removed when SSH temporarily failed
  - Now skips sync entirely if list_tmux_sessions() fails (preserves existing sessions)
- Tested all console commands:
  - `fcm sessions <vm>` - lists active sessions correctly
  - `fcm console <vm>` - creates session and connects (non-TTY error expected in test)
  - `fcm attach <vm> <session-id>` - attaches to existing session
- All 93 tests pass with zero warnings
- Commit: d78521c

### Task 29: Remove Legacy SSH Command (Not in PRD)
- The PRD specifies console/sessions/attach commands for VM access, not a bare ssh command
- With persistent console sessions fully implemented, the legacy ssh command is no longer needed
- main.rs:
  - Removed Ssh variant from Commands enum
  - Removed Commands::Ssh match arm
- client.rs:
  - Removed ssh_vm() function
  - Removed get_jump_host() function (only used by ssh_vm)
  - Removed SshInfoResponse struct
  - Removed std::process::Command import
  - Removed 5 related tests (ssh_info_deserialization, 4 get_jump_host tests)
- daemon.rs:
  - Removed SshInfoResponse struct
  - Removed handle_ssh_info() function
  - Removed /vms/{id}/ssh route from routing table
- All 88 tests pass with zero warnings
- Commit: 0a44c31

### Task 30: Add tmux to Base Rootfs Image
- PRD specifies tmux for persistent console sessions, but it was missing from Dockerfile
- rootfs/Dockerfile:
  - Added tmux to apk add package list
- Rebuilt base-rootfs.img with tmux included (145MB sparse)
- Tested with new VM (orbital-comet):
  - `fcm sessions` - correctly shows no sessions initially
  - `fcm console` - creates session successfully, connects to terminal server
  - `fcm attach` - attaches to existing session correctly
  - tmux session persists on VM (verified via direct SSH)
- All 88 tests pass with zero warnings
- Commit: e71ea59

### Task 31: macOS Cross-Compilation Script
- Created build-macos.sh script for cross-compiling fcm CLI to macOS
- Uses cargo-zigbuild with Zig as cross-linker (no macOS SDK required)
- Builds two targets:
  - aarch64-apple-darwin (Apple Silicon M1/M2/M3) - 2.5MB binary
  - x86_64-apple-darwin (Intel Mac) - 2.6MB binary
- Prerequisites: `cargo install cargo-zigbuild`, zig installed
- Usage: `./build-macos.sh`
- Outputs to target/<arch>-apple-darwin/release/fcm
- All 88 tests pass with zero warnings
- Commit: a87f4fc

### Task 32: Improve Console UX for Seamless Experience
- Improved console session persistence to match sprites.dev experience
- session.rs:
  - Added vm_session_name() for canonical session names (console-{vm_id})
  - Added get_or_create_console() method that:
    - Returns existing session if tracked in memory
    - Checks if tmux session exists on VM and registers it
    - Creates new tmux session only if needed
  - One session per VM instead of multiple sessions with IDs
  - Sessions survive client disconnects and daemon restarts
- daemon.rs:
  - Terminal handler now uses get_or_create_console() instead of get_session()
  - Auto-creates session if missing when client connects
- client.rs:
  - Removed session ID from console output
  - Cleaner UX: session details hidden from user
- console.rs:
  - Simplified output: "Connecting to <vm>..." instead of technical details
  - On detach: shows "Run 'fcm console <vm>' to reconnect"
  - Hide tmux implementation details completely
- Added test for vm_session_name()
- All 89 tests pass with zero warnings
- Commit: fe6eb83

### Task 33: Fix Tmux UX Issues
- Fixed tmux visual artifacts and sizing issues for cleaner experience
- session.rs:
  - Disable tmux status bar on session creation (`status off`)
  - Set `destroy-unattached off` to keep sessions alive
  - Resize tmux window to match client terminal before attaching
  - Separated session creation from option setting for reliability
- console.rs:
  - Added get_terminal_size() to detect client terminal dimensions
  - Send cols/rows in ConnectRequest to daemon
- daemon.rs:
  - Added cols/rows fields to TerminalConnectRequest
  - Pass terminal size to attach_to_session()
- Fixes:
  - No more tmux status bar at bottom
  - Terminal size matches client on connect
- All 89 tests pass with zero warnings
- Commit: fc088a3

### Task 34: Fix Session Attachment Bug
- Fixed bug where each connection created spurious tmux sessions (1, 2, 3...)
- Root cause: using `sh -c` with compound tmux commands caused extra sessions
- Solution: split into separate SSH calls for resize and attach
- Now correctly maintains single `console-{vm_id}` session per VM
- Multiple terminals connect to same session
- Session state persists across disconnects
- Commit: 7867c74

### Task 35: Remove Redundant sessions/attach Commands
- With single-session-per-VM model, sessions and attach commands became redundant
- Users only need `fcm console <vm>` to connect/reconnect to persistent session
- Removed from main.rs:
  - Sessions and Attach CLI command variants
  - Match arms for these commands
- Removed from client.rs:
  - list_sessions() and attach_session() functions
  - format_timestamp() helper
- Removed from daemon.rs:
  - GET /vms/{id}/sessions endpoint and handle_list_sessions() handler
  - DELETE /vms/{id}/sessions/{session-id} endpoint and handle_kill_session() handler
- Removed from session.rs:
  - list_sessions(), kill_session(), sync_sessions() methods
  - kill_tmux_session() helper function
  - test_session_manager_list_empty test
- Simplified CLI: now only 7 commands (create, ls, console, stop, start, destroy, daemon)
- All 88 tests pass with zero warnings
- Commit: 9b35d3a

### Task 36: Fix Session Recreation After User Exits Shell
- Bug: typing `exit` in console destroyed tmux session, but cached SessionInfo remained
- On reconnect, `get_or_create_console()` returned stale cached info without checking VM
- Result: "no sessions" error when trying to reconnect
- Fix: Always check if tmux session exists on VM before returning cached info
- If session was destroyed (user typed 'exit'), automatically recreate it
- All 88 tests pass with zero warnings
- Commit: 066296e

### Task 37: Procfile Deployment Support (Git Push Deployment)
- Implemented heroku-style git push deployment as specified in PRD
- Created git.rs module for git repository management:
  - repo_path(): returns path to VM's bare git repo at /root/<vm-name>.git
  - create_repo(): creates bare git repo with post-receive hook
  - delete_repo(): removes git repo when VM is destroyed
  - repo_exists(): checks if git repo exists for a VM
  - get_clone_url(): generates git clone URL for VM
  - generate_post_receive_hook(): creates hook that syncs code and runs deploy
- Post-receive hook functionality:
  - Checks out pushed code to temp directory
  - Syncs code to VM's /app directory via scp with sshpass
  - Runs fcm-deploy script on VM via ssh
  - Supports main and master branches
- Created fcm-deploy script (runs on VM):
  - Detects Ruby (Gemfile) and runs bundle install
  - Detects Python (requirements.txt) and runs pip install
  - Detects Node.js (package.json) and runs npm install
  - Parses Procfile for web process command
  - Starts/restarts web process using fcm-runner
- Created fcm-runner script (process manager on VM):
  - start/stop/restart/status commands
  - Manages PID file at /var/run/fcm-web.pid
  - Logs to /var/log/fcm-web.log
  - Exports PORT=8000 environment variable
- Updated vm.rs:
  - create_vm() now creates git repo after VM is running
  - destroy_vm() now deletes git repo when VM is destroyed
  - Added GitError variant to VmError enum
- Updated daemon.rs:
  - VmResponse now includes optional git_url field
  - Git URL is computed from VM name and server IP
- Updated client.rs:
  - VmResponse includes git_url field
  - print_vm() displays git URL when present
- Updated rootfs/Dockerfile:
  - Added nodejs and npm packages for Node.js apps
  - Added git package
  - Added fcm-deploy and fcm-runner scripts to /usr/local/bin
  - Created /app directory for deployments
- All 93 tests pass (single-threaded due to env var isolation)
- Commit: 6a3a3eb

### Task 38: Fix Git Deployment Issues Found During Testing
- Fixed issues discovered during end-to-end git deployment testing
- src/git.rs:
  - Added PATH export to post-receive hook (SSH sessions don't have system PATH)
  - Changed code sync from scp to tar-over-ssh (dropbear lacks sftp-server)
- rootfs/fcm-runner:
  - Added fuser -k to kill any process on PORT before starting
  - Prevents conflicts with old processes or init's default server
- rootfs/fcm-deploy:
  - Use full path /usr/local/bin/fcm-runner (not in PATH via SSH)
- rootfs/init:
  - Removed default HTTP server on port 8000 (conflicts with deployed apps)
  - Create /app directory for Procfile deployments at boot
- Tested full deployment flow:
  - `git push fcm master` syncs code and triggers deployment
  - Dependency detection works (Python, Ruby, Node.js)
  - Web process starts/restarts correctly on port 8000
  - Re-deployment properly stops old process before starting new one
- All 93 tests pass
- Commit: dfc771a

### Task 39: Add SSH Key to Host for Git Push Access
- Fixed git push requiring password by adding user's SSH key to host
- git.rs:
  - Added add_ssh_key_to_host() function
  - Creates /root/.ssh directory with 700 permissions if needed
  - Appends SSH public key to /root/.ssh/authorized_keys (600 permissions)
  - Avoids duplicate keys by checking existing entries
- daemon.rs:
  - Updated handle_create_vm() to call add_ssh_key_to_host() when SSH key provided
  - Key is added to host before VM creation proceeds
- Now when user runs `fcm create` with an SSH key:
  - Key is injected into VM's rootfs (for SSH into VM)
  - Key is added to host's authorized_keys (for git push to repo)
- All 94 tests pass
- Commit: 6ea98ab

### Task 40: Fix Git Push PATH Issue
- Fixed "git-receive-pack: command not found" error during git push
- Root cause: Non-interactive SSH sessions don't have PATH set
- Solution: Enable SSH user environment files
  - Set `PermitUserEnvironment yes` in /etc/ssh/sshd_config
  - Created /root/.ssh/environment with PATH
  - Restarted ssh service
- Git push now works without password using user's SSH key

### Task 41: Add GIT Column to ls Output
- Added GIT column to `fcm ls` command output
- Shows git repo address for each VM (e.g., root@64.34.93.45:vm-name.git)
- Makes it easy to find the correct remote URL for git push deployment
- Updated client.rs list_vms() function:
  - Added GIT to header row
  - Widened separator line to 120 chars
  - Added git_url field to each VM row
- All 94 tests pass with zero warnings
- Commit: 807f306

### Task 42: Improved Create Output with ASCII Art and Koans
- Redesigned `fcm create` output for better UX
- Added shaded ring ASCII art logo:
  - White ring with gray shading (░▒▓█)
  - Clean monochrome aesthetic
- Removed ID and IP from output (cleaner, less technical)
- Color scheme: gray comments, white commands, blue important values
- Added random zen koans displayed in index.html example:
  - "The code that is not written has no bugs."
  - "Before enlightenment: write code. After enlightenment: write code."
  - "What is the sound of one container crashing?"
  - ...and 9 more
- Added Quick Start section with step-by-step instructions:
  - git init
  - Create index.html with random koan
  - Create Procfile
  - Add remote and deploy
- All 94 tests pass with zero warnings
- Commits: 12d28b5, 8431fa0, 7ee5628, 281be7e, 3108f18, faee19b, 1879e09, bb7a1e8

### Task 43: Remove ID and IP from Command Output
- Simplified `fcm ls` table output to show only NAME, STATE, DOMAIN, GIT
- Removed ID and IP columns from list_vms() header and row output
- Updated print_vm() to remove ID, IP, and Port fields
- print_vm() now shows only Name, State, URL, and Git
- Added #[allow(dead_code)] to VmResponse fields still needed for JSON deserialization
- Adjusted column widths for cleaner table formatting
- All 94 tests pass with zero warnings
- Commit: f686a62

### Task 44: Fix Clippy Warning
- Fixed clippy::print_literal warning in list_vms()
- Embedded "GIT" literal directly in format string instead of passing as argument
- All 94 tests pass with zero clippy warnings
- Commit: 4283fcc

### Task 45: Add VCPU and Memory to ls and Create Output
- Added vcpu_count and mem_size_mib fields to VmConfig struct
- Used serde defaults so existing VMs get default values (1 vCPU, 512MB)
- Updated VmResponse in both daemon.rs and client.rs
- Updated list_vms() to show VCPU and MEMORY columns in table
- Updated print_vm() to display vCPU and Memory for stop/start/create output
- All 94 tests pass with zero warnings
- Commit: 5666774

### Task 46: Add Disk Space to ls and Create Output
- Added disk_used_mb() method to VmConfig using `du -m` for actual disk usage
- Added disk_max_mb() method using file metadata for apparent/max size
- Handles sparse files correctly (shows actual vs apparent size)
- Updated VmResponse to include both disk_used_mb and disk_max_mb
- Display format: "202MB/1024MB" (used/max)
- Updated list_vms() and print_vm() to show disk in used/max format
- All 94 tests pass with zero warnings
- Commits: 27bc32f, 5832b10

### Task 47: Show Deploy Success and URL After Git Push
- Updated post-receive hook to display deployment status and project URL
- On successful deploy: shows "-----> Deploy successful!" and the https URL
- On failed deploy: shows "-----> Deploy failed!" and exits with error
- Passed domain parameter to generate_post_receive_hook() for URL generation
- Updated create_repo() in git.rs to accept domain parameter
- Updated vm.rs to pass domain from expose config to git repo creation
- Suppressed SSH stderr noise in hook for cleaner output
- Updated test to verify new hook functionality
- All 94 tests pass with zero warnings
- Commit: a3a16e8

### Task 48: Stream Startup Logs in Git Push Output
- Added "Startup logs:" section to git push output
- Shows tail of /var/log/fcm-web.log after deployment
- On success: shows last 20 lines of startup logs
- On failure: shows last 30 lines to help debug errors
- Helps debug issues like gunicorn startup failures
- Refactored hook to use ssh_cmd() helper function
- All 94 tests pass with zero warnings
- Commit: f68a8d3

### Task 49: Fix pip install and PATH Issues for Python Deployments
- Fixed "gunicorn: not found" error during Python app deployment
- Root cause: Alpine Linux with Python 3.11+ requires --break-system-packages flag (PEP 668)
- rootfs/fcm-deploy:
  - Added --break-system-packages flag to pip3 install command
  - Without this flag, pip install silently fails on externally managed Python
- rootfs/fcm-runner:
  - Added PATH export to include /usr/local/bin:/usr/bin:/bin
  - Ensures pip-installed binaries (like gunicorn) are found when starting web process
- Rebuilt base-rootfs.img with updated scripts
- Updated scripts on existing VM (arctic-eclipse) for immediate fix
- All 94 tests pass with zero warnings
- Commit: 581a15b

### Task 50: Change Git Remote Name from fcm to origin
- Changed Quick Start instructions to use "origin" instead of "fcm"
- Users can now use default git commands: `git push origin main` or just `git push`
- Updated client.rs create_vm() output
- All 94 tests pass with zero warnings
- Commit: 81b3d4b

### Task 51: Fix Ruby Deployment with Native Gem Compilation
- Fixed "bundler: command not found: puma" error during Rails app deployment
- Root cause: Ruby gems with native extensions (puma, nokogiri, etc.) require build tools
- rootfs/Dockerfile:
  - Added build-base for gcc, make, etc.
  - Added ruby-dev for Ruby headers
  - Added libffi-dev, yaml-dev, zlib-dev, openssl-dev for common gem dependencies
- rootfs/fcm-deploy:
  - Changed bundle install to use local path (vendor/bundle) for isolation
  - Added config to exclude development and test groups
  - Show tail of install log on failures for debugging
- Rebuilt base-rootfs.img with build dependencies (512MB sparse)
- All 94 tests pass with zero warnings
- Commit: ad75f97

### Task 52: Increase Default VM Resources for Rails Deployment
- Fixed out-of-memory errors during Ruby gem compilation (bigdecimal, etc.)
- src/vm.rs:
  - Increased DEFAULT_MEM_SIZE_MIB from 512 to 1024
  - Updated test to match new default
- rootfs/build.sh:
  - Increased IMAGE_SIZE_MB from 1024 to 2048 (2GB disk)
  - Rails apps with bundled gems need more disk space
- rootfs/init:
  - Added automatic 512MB swap file creation on boot
  - Helps with memory-intensive operations like gem compilation
- New VMs now have: 1024MB RAM, 2GB disk, 512MB swap
- All 94 tests pass with zero warnings
- Commit: 2d40f52

### Task 53: Fix Rails Production Deployment Issues
- Fixed multiple issues preventing Rails apps from starting in production
- rootfs/fcm-runner:
  - Added RAILS_ENV=production, RACK_ENV=production, NODE_ENV=production
  - Added automatic SECRET_KEY_BASE generation (required for Rails production)
- rootfs/Dockerfile:
  - Added tzdata package (Rails needs timezone data)
  - Added sqlite-dev and postgresql-dev for database gem compilation
- Rebuilt base-rootfs.img with all fixes
- Successfully tested Rails 8.1 app deployment
- All 94 tests pass with zero warnings
- Commit: 760a042

### Task 54: Update CLI Description
- Changed "Simple Firecracker VM manager" to "Firecracker VM manager"
- Updated #[command(about = ...)] in src/main.rs
- All 94 tests pass with zero warnings
- Commit: 987453d

### Task 55: Add ASCII Art Logo to CLI
- Added big block letter "FCM" with gradient shading (░▒▓█)
- Uses clap's before_help attribute to display logo above help text
- All 94 tests pass with zero warnings
- Commit: df0db0a

### Task 56: Local .fcm Config File for Project-Linked VMs
- Added local config file support to link project directories to VMs
- When running `fcm` without arguments:
  - If .fcm file exists, shows VM info (name, state, URL, git, vCPU, memory, disk)
  - If no .fcm file, shows error message with help hint
- client.rs:
  - Added LocalConfig struct with name, url, git fields
  - Added save_local_config() to write .fcm to current directory
  - Added load_local_config() to read .fcm from current directory
  - Added show_local_vm() to display VM info from local config
  - Fetches live VM state from daemon if available
  - Shows helpful commands (fcm console, git push)
- main.rs:
  - Made Commands subcommand optional (Option<Commands>)
  - When no command given, calls show_local_vm()
- create_vm() now saves .fcm file after successful VM creation
- Added 3 unit tests for LocalConfig serialization/deserialization
- All 97 tests pass with zero warnings
- Commit: 7b34ae0

### Task 57: Show Help Directly When No .fcm File Exists
- Changed behavior when running `fcm` without arguments and no .fcm file present
- Previously: showed error message telling user to run `fcm --help`
- Now: displays help output directly using clap's CommandFactory trait
- main.rs:
  - Added CommandFactory import from clap
  - Changed error handler to call `Cli::command().print_help()` instead of error message
  - Removed exit(1) since showing help is not an error condition
- All 97 tests pass with zero warnings
- Commit: c9ccbda

### Task 58: Prevent Duplicate VM Creation When .fcm Exists
- Changed `fcm create` behavior when .fcm file already exists in current directory
- Instead of creating a new VM, shows existing VM info (same as `fcm` without args)
- Prevents accidentally creating multiple VMs for the same project
- client.rs:
  - Added check for local_config_path().exists() at start of create_vm()
  - Returns show_local_vm() if .fcm file found
- All 97 tests pass with zero warnings
- Commit: b613efa

### Task 59: Make VM Argument Optional for console/stop/start/destroy
- Commands now default to VM from .fcm file when no argument provided
- Explicit VM name argument still takes precedence
- main.rs:
  - Changed vm field from String to Option<String> for Console, Stop, Start, Destroy
  - Updated match arms to resolve VM name before calling handlers
- client.rs:
  - Added resolve_vm_name(vm: Option<String>) helper function
  - Returns provided name or loads from .fcm config
- Usage examples:
  - `fcm console` - uses VM from .fcm
  - `fcm console other-vm` - uses explicit name
  - `fcm stop` - uses VM from .fcm
- All 97 tests pass with zero warnings
- Commit: 9bb24b5

### Task 60: Add Comprehensive README with Installation Guide
- Created README.md with clear, simple documentation
- Project overview explaining what fcm is (Heroku-style deploys on bare metal)
- Quick start example showing VM creation and git push deployment
- All CLI commands documented with usage examples
- Complete bare metal installation guide for Ubuntu 22.04+:
  - Rust and build tools
  - Firecracker v1.7.0 installation
  - Caddy installation for SSL
  - sshpass and Docker setup
  - Building fcm from source
  - Kernel download
  - Base rootfs image build
  - Network configuration (IP forwarding)
  - SSH environment setup for git push
  - Daemon startup
  - Client configuration with token
- Architecture diagram showing VM -> Bridge -> Caddy -> Internet flow
- Procfile documentation with auto-detection table
- VM specs (1 vCPU, 1024MB RAM, 2GB disk, 512MB swap)
- Environment variables (FCM_HOST, FCM_TOKEN)
- Troubleshooting section for common issues
- All 97 tests pass with zero warnings
- Commit: 1dcdce4

### Task 61: Improve Deployment Scripts for Better App Compatibility
- Fixed platform-specific gem issues when pushing from macOS to Linux VM
- rootfs/fcm-deploy:
  - Remove Gemfile.lock before bundle install
  - Prevents errors from platform-specific gems (macOS -> Linux mismatch)
- rootfs/fcm-runner:
  - Added .env file support - loads /app/.env if it exists
  - Environment variables now use defaults instead of hardcoded values
  - RAILS_ENV, RACK_ENV, NODE_ENV can be overridden via .env
  - Added support for common app environment variables:
    - JWT_SECRET_KEY for JWT authentication
    - REDIS_URL for Redis connections
    - NOTIFIER_SERVICE_TOKEN for notification services
    - DISABLE_BOOTSNAP for Rails bootsnap control
  - Use explicit `env` command to pass all variables to subprocess
- All 97 tests pass with zero warnings
- Commit: 07c36f9

### Task 62: Require SSH Key for VM Creation
- Fixed "Permission denied (publickey)" error when users without SSH keys tried git push
- Problem: Previously showed warning if no SSH key found but created VM anyway
- Users couldn't push because server requires publickey auth for git
- client.rs:
  - Changed create_vm() to require SSH key instead of optional
  - Shows clear error message with instructions when no key found:
    - "No SSH key found"
    - "An SSH key is required for git push deployment."
    - "Generate one with: ssh-keygen -t ed25519"
    - "Then run fcm create again."
  - Fails early with helpful guidance instead of creating unusable VM
- All 97 tests pass with zero warnings
- Commit: fe760bd

### Task 63: Public Status Page at fcm.[ip].sslip.io
- Added barebones HTML status page (Warren Buffet style) for public viewing
- Page explains what fcm is in one paragraph
- Shows how to deploy with git push workflow
- Live daemon status section:
  - Uptime (formatted as Xd Xh Xm)
  - VM counts (running vs stopped)
- VM table showing:
  - Name
  - State (colored green for running, gray for stopped)
  - Domain
  - Disk usage (MB)
- Status page server runs on internal port 7780
- Caddy proxies fcm.[publicip].sslip.io to localhost:7780 with auto-SSL
- Page dynamically generates VM list on each request
- Simple serif font (Georgia), clean layout, minimal styling
- src/daemon.rs:
  - Added DaemonStats struct to track start_time and server_ip
  - Added generate_status_html() to render the page
  - Added run_status_server() TCP server for serving HTML
  - Updated run() to start status server and configure Caddy domain
- Publicly accessible at https://fcm.64-34-93-45.sslip.io
- All 97 tests pass with zero warnings
- Commit: 03eaca3
- Fix: Ensure /etc/caddy/ directory exists before writing Caddyfile
  - Makes daemon more robust on fresh machines without Caddy
  - Status page still works locally on port 7780 even if Caddy not installed
- Commit: 7aa37fe

### Task 64: Fix Clippy Warning in Status Server
- Fixed clippy::manual_flatten warning in run_status_server()
- Changed `for stream in listener.incoming() { if let Ok(mut stream) = stream { ... } }`
- To more idiomatic `for mut stream in listener.incoming().flatten() { ... }`
- All 97 tests pass with zero clippy warnings
- Commit: c503510

### Task 65: Clickable Domain Links and VM Sorting by Creation Date
- Made domain column in HTML status page a clickable link (`<a href>` with `target="_blank"`)
- Added `created_at` field to VmConfig struct for tracking VM creation time
- New VMs get current Unix timestamp; existing VMs use file modification time as fallback
- VMs now sorted by creation date (newest first) in both:
  - CLI `fcm ls` command
  - HTML status page at fcm.[ip].sslip.io
- Updated VmResponse in both daemon.rs and client.rs to include created_at
- Updated tests to include created_at field
- All 97 tests pass with zero warnings
- Commit: 9963b30
- Follow-up: Changed sort order to descending (newest first)
- Commit: 0e8b957

### Task 66: Google OAuth2 Login for Status Page
- Added Google OAuth2 authentication to the public status page
- src/daemon.rs:
  - Added Google OAuth2 configuration constants (client ID, secret, callback path)
  - Added GoogleUserInfo and GoogleTokenResponse structs for API responses
  - Added SessionStore type (Arc<Mutex<HashMap<String, GoogleUserInfo>>>) for sessions
  - Added URL encoding/decoding helpers (url_encode, url_decode)
  - Added parse_query_string() and parse_cookies() for HTTP request parsing
  - Added exchange_code_for_token() to exchange auth code for access token
  - Added fetch_google_user_info() to get user profile from Google
  - Added build_google_auth_url() to generate OAuth authorization URL
  - Added parse_http_request() for proper HTTP method/path/header parsing
  - Added send_redirect() and send_html_response() helper functions
  - Added html_escape() to prevent XSS in user names
  - Updated generate_status_html() to accept optional user info
  - Updated run_status_server() to handle OAuth callback, logout, and sessions
  - OAuth callback path: /oauth2/callback
  - Login button: "Login with Google" (blue button, Google brand color #4285f4)
  - When logged in: shows "Welcome, [name]" with logout link
  - Session cookies: HttpOnly, Secure, SameSite=Lax, 7-day expiry
  - Logout clears session cookie and removes from session store
- All 97 tests pass with zero warnings
- Commit: 7f73ff3

### Task 67: CLI Login, Logout, Whoami Commands
- Implemented multi-user authentication CLI commands as specified in PRD
- main.rs:
  - Added Login, Logout, Whoami command variants
  - Added match arms to call client functions
- client.rs:
  - Added login() function:
    - Starts local TCP server on port 9876
    - Opens browser to /cli-login endpoint on status page
    - Parses OAuth callback with token, name, email params
    - Saves user token (fcm_...) to ~/.fcm-token
    - Shows "Logged in as [name] ([email])" on success
  - Added logout() function: removes ~/.fcm-token file
  - Added whoami() function:
    - Shows "Using legacy daemon token (admin access)" for non-fcm_ tokens
    - Calls GET /auth/me to get user info for fcm_ tokens
  - Added AuthMeResponse struct for /auth/me deserialization
  - Added status_page_url() to build status page URL from FCM_HOST
  - Added open_browser() cross-platform helper (macOS/Linux/Windows)
  - Added parse_query_params() for URL query string parsing
- daemon.rs:
  - Added UserDatabase, UserRecord, TokenRecord structs for users.json storage
  - Added users_db_path(), load_user_db(), save_user_db() for database I/O
  - Added generate_user_token() to create fcm_... tokens
  - Added create_or_update_user() to create user record and token
  - Added /cli-login endpoint to status page server:
    - Accepts port parameter from CLI
    - Redirects to Google OAuth with state=cli:{port}
  - Updated OAuth callback to handle CLI login:
    - Detects CLI login via state parameter
    - Creates user token and redirects to http://127.0.0.1:{port}/callback
    - Passes token, name, email in query params
  - Added extract_bearer_token() helper
  - Updated validate_auth() to accept both legacy daemon token and user tokens
  - Added get_user_from_token() to look up user from token
  - Added AuthMeResponse struct for API response
  - Added handle_auth_me() handler for GET /auth/me endpoint
  - Added /auth/me route to API routing
  - Updated build_google_auth_url() to accept optional state parameter
  - First user to login becomes admin (is_admin: true)
- All 97 tests pass with zero clippy warnings
- Commit: 356d06a

### Task 68: VM Ownership and Per-User Access Control
- Implemented per-user VM ownership as specified in PRD
- src/vm.rs:
  - Added owner field to VmConfig struct (optional, for backward compatibility)
  - Updated VmConfig::new() to accept owner parameter
  - Updated create_vm() to accept owner parameter
  - VMs created with legacy daemon token have no owner (None)
  - VMs created with user tokens have owner set to user's Google ID
- src/daemon.rs:
  - Added AccessLevel enum with Admin and User variants
  - AccessLevel::Admin: full access to all VMs (legacy daemon token)
  - AccessLevel::User: access only to owned VMs (or all if is_admin flag set)
  - Added can_access_vm() method to check VM access based on ownership
  - Added owner_id() method to get user ID for VM creation
  - Added get_access_level() to determine request authorization
  - Updated handle_create_vm() to pass owner to vm::create_vm()
  - Updated handle_list_vms() to filter VMs by access level
  - Updated handle_get_vm() to check ownership before returning VM
  - Updated handle_stop_vm() to check ownership before stopping
  - Updated handle_start_vm() to check ownership before starting
  - Updated handle_destroy_vm() to check ownership before destroying
  - Updated handle_create_session() to check ownership before creating console session
  - Updated handle_terminal_connection() to validate user tokens and check VM access
  - Added VmResponse.owner field for API responses
  - Removed unused validate_auth() function (replaced by get_access_level)
- Access control rules:
  1. Legacy daemon token (/var/lib/firecracker/.token): full access to all VMs
  2. User token (fcm_...): access only to VMs with matching owner field
  3. Admin users (is_admin: true): can see/manage all VMs
  4. Legacy VMs (no owner): accessible to all authenticated users
- Added 6 unit tests for AccessLevel access control logic
- All 103 tests pass with zero clippy warnings
- Commit: 2148e58

### Task 69: Fix Login Callback Page Encoding and Add ASCII Art
- Fixed garbled characters on login successful/failed callback pages
- Root cause: missing UTF-8 charset declaration in HTML
- Added `<meta charset="UTF-8">` to both pages
- Added ASCII art ring logo (same as terminal create output) to both pages
- Applied dark theme styling (#1a1a1a background, white/gray text)
- Success page: blue title color (#4a9eff)
- Error page: red title color (#ff4a4a)
- Consistent branding with terminal output
- All 103 tests pass with zero warnings
- Commit: 97b78fe

### Task 70: Filter Status Page VMs by User Ownership
- Status page now shows only VMs owned by the logged-in user
- Not logged in: shows "Login to see your VMs" message in table
- Admin users (is_admin: true): see all VMs
- Regular users: see only VMs with matching owner field
- src/daemon.rs:
  - Changed generate_status_html() to accept UserRecord instead of GoogleUserInfo
  - Added VM filtering based on user access level
  - Look up UserRecord from database to get is_admin status
  - VM counts in status section also reflect filtered list
- All 103 tests pass with zero warnings
- Commit: 3b875dd

### Task 71: CLI Download Links and Commit Hash on Status Page
- Added releases directory (/var/lib/firecracker/releases/) for versioned binaries
- Created build-release.sh script for building platform-specific releases:
  - Linux x86_64 (native build)
  - macOS ARM64 (Apple Silicon via cargo-zigbuild)
  - macOS x86_64 (Intel via cargo-zigbuild)
  - Packages as tar.gz with commit hash in filename (fcm-{commit}-{platform}.tar.gz)
  - Writes COMMIT file with current short hash
- src/daemon.rs:
  - Added RELEASES_DIR constant
  - Added Release struct for tracking available binaries
  - Added get_current_commit() to read commit hash from COMMIT file
  - Added list_releases() to scan releases directory
  - Updated generate_status_html() with "Download CLI" section:
    - Platform buttons: "macOS (Apple Silicon)", "macOS (Intel)", "Linux (x86_64)"
    - Version displayed as short commit hash (e.g., 24c7247)
  - Added /releases/ route to serve binary files with proper Content-Type
  - Footer now shows commit hash
- All 103 tests pass with zero clippy warnings
- Commit: 299b972

### Task 72: Add Quick Start Section to fcm Without Args Output
- Added Quick Start deployment example to `fcm` command when run without args in a directory with .fcm file
- Shows same git workflow as `fcm create` output:
  - git init
  - echo '<h1>koan</h1>' > index.html
  - echo 'web: python3 -m http.server $PORT' > Procfile
  - git remote add origin <git-url>
  - git add -A && git commit -m 'init' && git push origin main
- Uses random_koan() for the index.html content
- Provides immediate guidance for users who return to a project
- All 103 tests pass with zero warnings
- Commit: a32fb48

### Task 73: Move Google OAuth Credentials to .env File
- Removed hardcoded Google OAuth credentials from source code
- src/daemon.rs:
  - Removed GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET constants
  - Added load_oauth_credentials() function to read from env vars or .env file
  - Updated exchange_code_for_token() to use loaded credentials
  - Updated build_google_auth_url() to use loaded credentials
- Created .env.example showing required variables
- Created .env file with actual credentials (gitignored)
- Added .env to .gitignore
- Rewrote git history using filter-branch to remove credentials from all past commits
- Cleaned up stale refs and ran garbage collection
- All 103 tests pass with zero warnings
- Commit: 279fa63

### Task 74: Reduce Base Image Size by Removing LLVM Bloat
- Identified that postgresql-dev was pulling in LLVM (~385MB) as a dependency
- LLVM is needed for PostgreSQL's server-side JIT, but we only need client libraries
- rootfs/Dockerfile:
  - Changed `postgresql-dev` to `libpq-dev`
  - libpq-dev provides only the client libraries needed for the pg gem
- Rebuilt base-rootfs.img:
  - Before: 452.9 MiB in packages → ~1.4GB on disk with swap
  - After: 453 MiB in packages → ~500MB on disk with swap
- VM disk usage reduced from 1412MB to 496MB (916MB savings per VM)
- All runtimes still work: Ruby 3.4.8, Python 3.12.12, Node.js 24.13.0
- All 103 tests pass
- Commit: c2b4438

### Task 75: Change Default Web Process Port from 8000 to 3000
- Changed the default port for web processes in VMs from 8000 to 3000
- src/daemon.rs:
  - Updated DEFAULT_EXPOSE_PORT constant from 8000 to 3000
  - Updated status page HTML example
  - Updated comment in handle_create_vm()
  - Updated test assertion
- rootfs/fcm-runner:
  - Changed PORT variable from 8000 to 3000
- rootfs/fcm-deploy:
  - Changed PORT variable from 8000 to 3000
- README.md:
  - Updated Quick Start Procfile example
  - Updated Commands section description
  - Updated architecture diagram (:3000 for VM ports)
  - Updated Procfile documentation
- PRD.md:
  - Updated command documentation
  - Updated Procfile section
  - Updated init script description
  - Updated config.json example
- src/caddy.rs:
  - Updated all test cases (12 occurrences)
- src/client.rs:
  - Updated test JSON and assertions
- src/vm.rs:
  - Updated test for ExposeConfig
- All 103 tests pass with zero clippy warnings
- Commit: cb2928c

### Task 76: Add Bun Runtime Support
- Added Bun 1.3.6 JavaScript runtime to base VM image
- rootfs/Dockerfile:
  - Added unzip package (required for Bun installer)
  - Added Bun installation via official install script
  - Bun binary installed to /usr/local/bin/bun
  - Created bunx symlink for package runner
- rootfs/fcm-deploy:
  - Added PATH export to ensure /usr/local/bin is searched
  - Detect Bun projects by presence of bun.lockb file
  - Use `bun install --production` for Bun projects
  - Fall back to npm for projects without bun.lockb
- Rebuilt base-rootfs.img with Bun (640MB sparse)
- Bun apps can now be deployed with `bun start` in Procfile
- All 103 tests pass with zero warnings
- Commit: 20b9363

### Task 77: Status Page Runtime Tags and Release Cleanup
- Added runtime version tags to status page with brand colors:
  - Ruby 3.4 (red #cc342d)
  - Python 3.12 (blue #3776ab)
  - Node.js 24 (green #339933)
  - Bun 1.3 (beige #fbf0df)
- Cleaned up releases directory to only show latest version
- Updated README.md with Bun in auto-detection table and base image breakdown
- All 103 tests pass with zero warnings
- Commits: feaea00, e909917

### Task 78: PRD Update - WebSocket+PTY Console Architecture
- Updated PRD.md to document new WebSocket+PTY console architecture (like Sprite)
- Replaces SSH+tmux approach with simpler fcm-agent PTY manager
- Changes made to PRD.md:
  - Commands section: removed `sessions` and `attach` commands (already removed from code)
  - Project structure: updated session.rs description
  - Persistent console sessions: complete rewrite with new architecture
    - New diagram: CLI → Daemon → fcm-agent → PTY → shell
    - fcm-agent manages PTY directly (no SSH/tmux for console)
    - JSON framed terminal protocol specification
    - One session per VM, auto-reconnect, auto-respawn shell
  - Base image: replaced tmux with fcm-agent, clarified SSH is only for git push
  - Verification: simplified flow (removed sessions/attach steps)
- Benefits of new architecture:
  - No SSH/tmux dependencies for console access
  - Direct PTY = better signal handling, cleaner resize
  - JSON framed protocol = no raw byte streaming issues
  - Browser-ready for future web terminal
  - Simpler codebase
- Note: This is a PRD documentation update. Implementation will follow.
- Commit: d1f06bc

### Task 79: Implement fcm-agent Binary for VM
- Created fcm-agent/ directory with separate Cargo.toml for minimal binary
- fcm-agent/src/main.rs: ~220 lines of Rust, PTY manager implementation
- Features:
  - Listens on TCP port 7779 (internal network only)
  - Spawns /bin/sh in PTY using libc::forkpty
  - Proxies stdin/stdout via JSON framed messages (newline-delimited)
  - Base64 encodes terminal I/O: {"stdin":"..."} and {"stdout":"..."}
  - Handles terminal resize: {"resize":{"cols":N,"rows":N}}
  - Sends exit notification: {"exit":N} when shell exits
  - Automatically respawns shell after exit
  - Non-blocking I/O for responsive terminal experience
- Build optimizations: opt-level=z, LTO, codegen-units=1, strip=true
- Built for x86_64-unknown-linux-musl target (~450KB static binary)
- rootfs/Dockerfile:
  - Removed tmux package (replaced by fcm-agent)
  - Added COPY fcm-agent to /usr/local/bin/fcm-agent
- rootfs/init:
  - Added fcm-agent startup after dropbear SSH
  - Logs to /var/log/init.log with PID tracking
- Updated .gitignore to exclude fcm-agent/target/
- All 103 tests pass with zero warnings
- Commit: ef11ac4

### Task 80: Update session.rs to Connect to fcm-agent Instead of SSH+tmux
- Rewrote session.rs to use TCP connection to fcm-agent on port 7779
- Removed SSH+tmux session management (fcm-agent handles PTY directly)
- Added JSON protocol helpers:
  - base64_encode() and base64_decode() for terminal I/O
  - extract_stdout(), extract_stdin(), extract_exit_code() for JSON parsing
  - make_stdin_message() and make_resize_message() for message creation
- Added connect_to_agent() function to establish TCP connection to VM:7779
- Added send_resize() to send initial terminal size
- Added AgentConnection wrapper struct for convenience
- Updated SessionError variants:
  - Removed SshError and TmuxError (no longer using SSH/tmux)
  - Added ConnectionFailed for agent connection errors
- Updated SessionInfo struct:
  - Renamed tmux_session field to session_name
- Updated daemon.rs terminal handler (handle_terminal_connection):
  - Connect to fcm-agent instead of spawning SSH+tmux
  - New proxy_agent_io() function for JSON message proxying
  - Client sends raw bytes, daemon encodes to {"stdin":"base64"}
  - Agent sends {"stdout":"base64"}, daemon decodes and sends raw bytes to client
- Updated client.rs SessionResponse to match new field name (session_name)
- Rebuilt base rootfs image with fcm-agent
- Tested console connection successfully:
  - Daemon connects to fcm-agent on VM port 7779
  - JSON protocol works correctly (resize, stdin, stdout)
  - Console command connects and receives shell prompt
- All 109 tests pass with zero clippy warnings
- Commit: 61456d3

### Task 81: Terminal Resize Handling During Console Session
- Added SIGWINCH signal handler to detect terminal resize during console sessions
- src/console.rs:
  - Added RESIZE_PENDING static AtomicBool flag
  - Added sigwinch_handler() - sets flag when signal received
  - Added install_sigwinch_handler() - installs signal handler using libc::sigaction
  - Added make_resize_message() - creates JSON resize message format
  - Updated connect() function to:
    - Install SIGWINCH handler on connection
    - Track last known terminal size
    - Check RESIZE_PENDING flag in main loop
    - Send resize message when terminal size changes
    - Handle EINTR to detect resize after signal
- src/daemon.rs:
  - Updated proxy_agent_io() to detect resize messages from client
  - Resize messages (starting with {"resize") are forwarded directly to fcm-agent
  - Other data is wrapped in stdin JSON messages as before
- Protocol flow:
  1. User resizes terminal window
  2. Kernel sends SIGWINCH to client process
  3. Signal handler sets RESIZE_PENDING flag
  4. Main loop detects flag, gets new terminal size
  5. Client sends {"resize":{"cols":N,"rows":N}} to daemon
  6. Daemon forwards resize message to fcm-agent
  7. fcm-agent applies resize to PTY (TIOCSWINSZ ioctl)
- Added test for make_resize_message()
- All 110 tests pass with zero clippy warnings
- Commit: bee74d1

### Task 82: Show Shell Exit Notification in Console Sessions
- Added shell exit handling to console sessions
- When user types `exit` in console, fcm-agent sends {"exit":N} message
- Previously daemon ignored exit messages (shell respawns automatically on agent)
- Now daemon detects exit messages and sends user-friendly notification to client
- Notification: "[Shell exited (code N), new shell spawned]" displayed in gray
- src/daemon.rs:
  - Added extract_exit_code to imports from session module
  - Updated proxy_agent_io() to detect {"exit":N} messages
  - Send ANSI-formatted notification to client (gray text with \x1b[90m)
- src/session.rs:
  - Removed #[allow(dead_code)] from extract_exit_code() (now used)
  - Removed #[allow(dead_code)] from extract_json_number() (transitively used)
- User experience: console stays connected after exit, new shell prompt appears
- All 110 tests pass with zero clippy warnings
- Commit: 706e48c

### Task 83: Persist PTY Session Across Client Disconnects in fcm-agent
- Fixed critical bug: shell was killed when client disconnected
- PRD requires: "if client disconnects, PTY session keeps running on fcm-agent"
- Previous behavior: each TCP connection spawned new shell, disconnect killed it
- fcm-agent/src/main.rs:
  - Added SHELL_INITIALIZED AtomicBool flag to track if shell was spawned
  - Added CONNECTION_LOCK Mutex to ensure only one client connects at a time
  - Added ensure_shell_running() function:
    - Returns existing shell if still alive
    - Only spawns new shell if needed (first connect or after user exit)
  - Updated handle_connection():
    - Uses ensure_shell_running() instead of always spawning new shell
    - Removed shell cleanup on disconnect (shell persists for next client)
    - Logs "shell preserved for reconnect" on disconnect
- Rebuilt base-rootfs.img with updated fcm-agent binary
- Tested with new VM (photon-tensor):
  - fcm-agent logs show "Spawned shell (pid 535)" only once
  - Multiple client disconnects show "shell preserved for reconnect"
  - Shell process (pid 535) remains alive across disconnects
  - Verified via `ps aux` that shell persists on VM
- All 110 tests pass with zero clippy warnings
- Commit: 1faffcd

### Task 84: Simplify Terminal Protocol to Match PRD Spec
- Removed session field from terminal connect protocol (matches PRD specification)
- PRD specifies: {"vm":"..","token":"..","cols":N,"rows":N} without session field
- Since there's "one session per VM", the daemon auto-creates/reuses sessions internally
- src/daemon.rs:
  - Removed session field from TerminalConnectRequest struct
  - Removed SessionResponse and CreateSessionRequest structs
  - Removed handle_create_session handler function
  - Removed POST /vms/{id}/sessions endpoint from routing
  - Removed 2 related tests (test_session_response_from_info, test_create_session_request_default)
  - Removed unused SessionError and SessionInfo imports
- src/console.rs:
  - Removed session field from ConnectRequest struct
  - Updated connect() function signature: now only takes vm name (no session ID)
  - Updated test_connect_request_serialization test
- src/client.rs:
  - Simplified console_vm() to call console::connect() directly (no HTTP API call)
  - Removed SessionResponse struct (no longer needed)
- src/session.rs:
  - Added #[allow(dead_code)] to create_session() (legacy method, now unused)
- Tested full console flow:
  - fcm console photon-tensor connects successfully with simplified protocol
  - Daemon logs "Terminal connection: vm=photon-tensor" (no session field)
  - Persistent shell (PID 535) maintained by fcm-agent across reconnects
- All 108 tests pass with zero clippy warnings
- Commit: 5e05c3c

### Task 85: Fix Missing Shell Prompt on Console Reconnect
- Fixed issue where reconnecting to a console showed no shell prompt
- Problem: Shell already printed prompt before disconnect, doesn't re-print on reconnect
- Solution: Send SIGWINCH signal to shell when client reconnects
- SIGWINCH causes most shells to redraw/refresh their prompt
- fcm-agent/src/main.rs:
  - Added `libc::kill(child_pid, libc::SIGWINCH)` after `ensure_shell_running()`
- Rebuilt base-rootfs.img with updated fcm-agent binary
- All 108 tests pass with zero clippy warnings
- Commit: 7db96e8

### Task 86: Make Exit Disconnect from Console (SSH Behavior)
- Changed `exit` to disconnect from console instead of respawning shell
- Previous behavior: shell respawned immediately, connection stayed open
- New behavior: shell exits, connection closes (like SSH)
- Shell respawns automatically on next `fcm console` connection
- fcm-agent/src/main.rs:
  - On shell exit: mark shell as not initialized, close connection
  - Shell will spawn fresh on next client connection
- src/daemon.rs:
  - When receiving `{"exit":N}`, close connection instead of showing message
- src/console.rs:
  - Removed "(Ctrl+] to detach)" hint - exit is the natural way out
  - Ctrl+] still works as escape hatch if needed
- Ctrl+C works normally (sends SIGINT to current shell command)
- All 108 tests pass with zero clippy warnings
- Commit: 86eed53

### Task 87: Fix Console Reconnect Hanging Issue
- Fixed issue where second console connection would not receive shell output
- Problem: When client disconnects, daemon's reader thread blocks on read_line()
  from fcm-agent forever, holding fcm-agent's CONNECTION_LOCK
- This prevented new connections from getting any shell output
- Root cause: fcm-agent keeps shell alive (persistent session), never closes
  its connection, so daemon's reader thread never gets EOF
- Solution: Shutdown the agent connection when client disconnects
- src/daemon.rs:
  - Added `agent_write.shutdown(std::net::Shutdown::Both)` before join()
  - This signals fcm-agent that connection is closed, unblocking reader
- Tested: Multiple consecutive reconnections now work correctly
- All 108 tests pass with zero clippy warnings
- Commit: 7086e9f

### Task 88: Clean Up Old Releases in Build Script
- Updated build-release.sh to delete old releases before creating new ones
- Keeps only one release per platform (1 linux, 1 mac) in releases directory
- Added rm -f commands to delete fcm-*-linux-x86_64.tar.gz and fcm-*-darwin-arm64.tar.gz
- Prevents accumulation of old versioned tarballs
- Tested: releases directory went from 18 files to 2 after running script
- All 108 tests pass with zero warnings
- Commit: 31a8cf0

### Task 89: Add Claude Code to Base VM Image
- Added Claude Code CLI to base VM image (v2.1.19)
- rootfs/Dockerfile:
  - Install via official installer: `curl -fsSL https://claude.ai/install.sh | bash`
  - Copy binary to /usr/local/bin/claude (206MB)
  - Add /usr/local/bin to PATH in /etc/profile
- README.md:
  - Added Claude Code to Base Image Breakdown table (206 MB, latest)
- src/daemon.rs:
  - Added Claude Code tag to status page (orange #D97706)
- Rebuilt base-rootfs.img (848MB sparse with Claude Code)
- Tested in VM: `claude --version` returns "2.1.19 (Claude Code)"
- All 108 tests pass with zero warnings
- Commit: 0d8aed7

### Task 90: Fix Console PATH for Claude Code Access
- fcm-agent was spawning `/bin/sh` (non-login shell) which didn't source /etc/profile
- Changed to spawn `/bin/sh -l` (login shell) which sources /etc/profile
- Login shell now has /usr/local/bin in PATH, making `claude` command work
- Rebuilt fcm-agent and base-rootfs.img
- All 108 tests pass with zero warnings
- Commit: faed99d

### Task 91: Fix localhost Resolution for Claude Code OAuth
- Claude Code OAuth failed with "Failed to start server. Is port 0 in use?"
- Root cause: /etc/hosts file was missing, so `localhost` hostname didn't resolve
- Claude Code binds to `localhost` (hostname) not `127.0.0.1` (IP)
- rootfs/init:
  - Added `ip link set lo up` to bring up loopback interface
  - Added /etc/hosts with localhost entries:
    - 127.0.0.1   localhost localhost.localdomain
    - ::1         localhost localhost.localdomain
- Rebuilt base-rootfs.img with the fix
- Tested: localhost now resolves and pings correctly in VM
- All 108 tests pass with zero warnings
- Commit: 4b2d83e

### Task 92: Fix Console Reconnect Cursor Position for TUI Apps
- Problem: After reconnecting to console, cursor position was wrong in Claude Code
- Root cause: Was sending newline on reconnect, which doesn't trigger TUI redraw
- Fix: Send Ctrl+L (0x0C, form feed) instead of newline on reconnect
- Ctrl+L is the standard "refresh screen" command for terminal apps
- TUI applications like Claude Code respond to Ctrl+L by redrawing the entire screen
- Updated fcm-agent/src/main.rs needs_prompt_trigger handler
- Rebuilt fcm-agent and base-rootfs.img
- All 108 tests pass with zero warnings
- Commit: f5af605
- Follow-up: Also send clear screen sequence to client in daemon before proxy starts
- Clear screen (ESC[2J ESC[H) gives TUI app a clean slate to redraw into
- Commit: d51835e
- Follow-up: Simplified to minimal interference approach (see Task 93)

### Task 93: Minimal Interference Console Reconnect
- Simplified console reconnect to only use SIGWINCH signal
- Removed Ctrl+L injection in fcm-agent (was causing issues with some apps)
- Removed clear screen sequence in daemon.rs (interfered with raw terminal stream)
- Let SIGWINCH be the only signal to apps about terminal changes
- fcm-agent/src/main.rs:
  - Removed Ctrl+L write and 50ms delay on reconnect
  - Just log "Reconnect: SIGWINCH sent, no character injection"
- src/daemon.rs:
  - Removed clear screen (\x1b[2J\x1b[H) write before proxy starts
- Minimal interference approach works better with variety of terminal apps
- All 108 tests pass with zero warnings
- Commit: 9dac2ff

### Task 94: Serial Console via PTY (No fcm-agent)
- Implemented the PRD's "console redesign" to use Firecracker's serial console
- Replaces fcm-agent inside VM with direct PTY connection to Firecracker
- src/vm.rs:
  - spawn_firecracker() now creates PTY using libc::openpty()
  - Firecracker's stdin/stdout connected to PTY slave
  - Returns (Child, master_fd) instead of just Child
  - create_vm() and start_vm() now return (VmConfig, RawFd)
  - Added RawFd import from std::os::unix::io
- src/daemon.rs:
  - Added ConsoleFds type (Arc<Mutex<HashMap<String, RawFd>>>)
  - Store PTY master FDs when VMs are created/started
  - Close FDs when VMs are stopped/destroyed
  - Replaced run_terminal_server() to use ConsoleFds instead of SessionManager
  - Replaced handle_terminal_connection() for direct PTY proxy
  - Added set_pty_window_size() for TIOCSWINSZ ioctl
  - Added proxy_pty_io() for raw byte I/O to PTY master
  - Added parse_resize_message() for terminal resize handling
  - Removed fcm-agent JSON protocol (connect_to_agent, proxy_agent_io)
- src/session.rs:
  - Removed all fcm-agent protocol code (~270 lines)
  - Kept SessionManager for session tracking (cleanup on stop/destroy)
  - Removed: AGENT_PORT, connect_to_agent, send_resize, base64 encode/decode
  - Removed: extract_stdout/stdin/exit_code, make_stdin/resize_message
  - Removed: AgentConnection struct and related tests
- rootfs/init:
  - Replaced fcm-agent startup with agetty on ttyS0
  - agetty --autologin root --noclear ttyS0 115200 vt100
  - Serial console provides login shell without password prompt
- rootfs/Dockerfile:
  - Added agetty package (from util-linux)
  - Removed fcm-agent binary copy
- Benefits of serial console approach:
  - No agent process inside VM (fewer dependencies)
  - Raw bytes instead of JSON+base64 (lower latency, less overhead)
  - Standard Linux serial console (console=ttyS0 already configured)
  - ~370 fewer lines of code
  - Works even if VM network is broken
- Limitations:
  - PTY FDs lost on daemon restart (VMs keep running but console unavailable)
  - Need to stop/start VM to regain console after daemon restart
- All 99 tests pass with zero clippy warnings
- Commit: 7b0cba5

### Task 95: Rebuild Rootfs and Test Serial Console
- Rebuilt base-rootfs.img with agetty and without fcm-agent
- Build output: 848MB sparse, 2.0GB apparent size
- Verified serial console functionality:
  - Created test VM (cyber-vertex)
  - Terminal server connection successful ({"success":true})
  - Shell prompt received via PTY: `cyber-vertex:~#`
  - Commands execute correctly: uname, ps, whoami all work
  - agetty running properly on ttyS0 providing login shells
- Verified console output (via Python test client):
  - `uname -a` returns: Linux cyber-vertex 4.14.174 x86_64
  - `ps aux` shows: init, rngd, dropbear, agetty, login, shell processes
  - Alpine Linux edge OS correctly detected
- Note: init log shows "agetty DIED" due to timing of check (1 second after start)
  - This is a false alarm - agetty is actually running correctly
  - The PID check happens before agetty fully initializes via setsid
- No code changes (Dockerfile/init changes were in Task 94)
- Task 94's serial console implementation verified working end-to-end

### Task 96: Delete Unused fcm-agent and session Module (PRD Cleanup)
- Completed PRD cleanup: delete files marked for deletion in console redesign plan
- Deleted fcm-agent/ directory entirely (~350 lines of code):
  - fcm-agent/Cargo.toml
  - fcm-agent/src/main.rs
  - fcm-agent/target/ (build artifacts)
- Deleted src/session.rs (~246 lines of code):
  - SessionManager struct (no longer needed with direct PTY I/O)
  - SessionInfo struct
  - SessionError enum
  - 8 unit tests for session management
- Updated src/daemon.rs:
  - Removed `use crate::session::SessionManager;` import
  - Removed session_manager parameter from handle_stop_vm()
  - Removed session_manager parameter from handle_destroy_vm()
  - Removed session_manager parameter from handle_request()
  - Removed session_manager.remove_vm_sessions() calls
  - Removed SessionManager::new() in run()
- Updated src/main.rs:
  - Removed `mod session;` declaration
- Total code removed: ~600 lines
- PTY FD tracking now handled entirely by console_fds in daemon.rs
- All 91 tests pass with zero clippy warnings
- Commit: dd466f3

### Task 97: Update PRD to Document Serial Console Architecture
- Updated PRD.md to reflect the implemented serial console architecture
- Project structure section:
  - Removed session.rs (deleted in Task 96)
  - Updated vm.rs description to include "PTY management"
- Replaced "persistent console sessions" with "serial console (no agent)" section:
  - New architecture diagram showing PTY connection to Firecracker
  - Simplified explanation of how serial console works
  - Added benefits comparison table (fcm-agent vs serial console)
  - Updated terminal protocol documentation
  - Updated VM requirements (getty/agetty instead of fcm-agent)
- Updated base image section:
  - Changed fcm-agent to agetty in package list
  - Removed fcm-agent binary copy from Dockerfile
  - Updated init script description
- Added "console redesign implementation plan" section for reference
- All 91 tests pass with zero warnings
- Commit: 59e9271

### Task 98: Add zsh as Default Console Shell
- Added zsh as the default shell for serial console access
- Provides better interactive experience than default ash/sh:
  - Command history
  - Tab completion
  - Better prompt customization
  - Vi/Emacs keybindings
- rootfs/Dockerfile:
  - Added zsh package to base image
- rootfs/init:
  - Replaced agetty with direct zsh login shell on ttyS0
  - `setsid sh -c 'exec zsh --login' <>/dev/ttyS0 >&0 2>&1 &`
  - Simpler than agetty (no getty overhead)
- src/vm.rs:
  - Fixed openpty call: changed `std::ptr::null()` to `std::ptr::null_mut()`
  - Corrects type safety for mutable pointer parameters
- Rebuilt base-rootfs.img (855MB sparse)
- Verified zsh works via console:
  - `echo $0` returns "zsh"
  - `/bin/zsh` binary present
- All 91 tests pass with zero clippy warnings
- Commit: e9ae7a6

### Task 99: WebSocket Console Protocol (Sprite-style)
- Migrated console from raw TCP to WebSocket over TLS
- Added WebSocket dependencies to Cargo.toml:
  - tungstenite = { version = "0.24", features = ["native-tls"] } for WebSocket
  - url = "2" for URL parsing
  - native-tls = "0.2" for TLS support
- src/daemon.rs:
  - Changed TERMINAL_BIND_ADDR from "0.0.0.0:7778" to "127.0.0.1:7778"
  - Terminal server now localhost-only (Caddy proxies external connections)
  - Added WsConsoleRequest struct for WebSocket query params (vm, cols, rows, env)
  - Added parse_ws_query_params() to parse URL query string
  - Rewrote handle_terminal_connection() for WebSocket:
    - Uses tungstenite::accept_hdr() with custom callback
    - Auth via Bearer token in Authorization header during WebSocket upgrade
    - Connection params (vm name, terminal size) from URL query string
  - Added proxy_websocket_pty() for WebSocket <-> PTY I/O:
    - Binary frames for terminal I/O (raw bytes)
    - Text frames for control messages (resize)
  - Updated run() to use add_fcm_domain() instead of add_site()
  - Removed old TCP-based code (TerminalConnectRequest, proxy_pty_io, etc.)
- src/console.rs:
  - Added url_encode() for URL query parameter encoding
  - Changed get_websocket_url_base() to build wss:// URLs
  - Rewrote connect() for WebSocket client:
    - Builds WebSocket URL with query params (vm, cols, rows)
    - Connects with Authorization header
    - Binary frames for terminal I/O
    - Text frames for resize messages
  - Updated make_resize_message() to JSON format: {"type":"resize","cols":N,"rows":N}
- src/caddy.rs:
  - Added generate_fcm_domain_block() for WebSocket console proxy config
  - Added add_fcm_domain() and add_fcm_domain_to_file()
  - Caddy config has /console route proxying to localhost:7778
- Protocol specification:
  - Auth: Bearer token in WebSocket upgrade Authorization header
  - Connection: wss://fcm.{ip}.sslip.io/console?vm={name}&cols={N}&rows={N}
  - Data frames: Binary for terminal I/O, Text for control (resize)
  - Resize message format: {"type":"resize","cols":N,"rows":N}
  - TLS provided by Caddy (wss:// externally, ws:// to localhost)
- WebSocket server responds with 101 Switching Protocols for valid connections
- All 90 tests pass with zero clippy warnings
- Commit: 84ead22

### Task 100: Environment Variable Passthrough to Shell
- Completed PRD Task 99 feature: passing client environment variables to VM shell
- Environment variables (TERM, SHELL, COLORTERM, LANG) are parsed from WebSocket URL query params
- Added shell_escape() function to safely quote values for shell assignment
- Export commands written to PTY on console connect before proxy starts
- Security: only allow safe variable names (alphanumeric and underscore)
- src/daemon.rs:
  - Added shell_escape() function (single-quote escaping)
  - Added env var export loop in handle_terminal_connection()
  - Removed #[allow(dead_code)] from env field in WsConsoleRequest
  - Added test_shell_escape() unit test
- Flow:
  1. Client builds WebSocket URL with env params (e.g., env=TERM=xterm-256color)
  2. Server parses env vars from query string
  3. On connection, server writes `export VAR='value'` commands to PTY
  4. Shell in VM receives environment variables
- All 91 tests pass with zero clippy warnings
- Commit: fa3df84

### Task 101: OSC Title Prefix and Terminfo Upload
- Implemented two remaining features from Task 99 PRD spec
- **OSC Title Prefix (console.rs):**
  - Added OscState enum state machine for parsing OSC sequences
  - Detects OSC title sequences: \x1b]0;{title}\x07 and \x1b]0;{title}\x1b\\
  - Also handles OSC code 2 (window title)
  - Rewrites titles with "fcm: " prefix for clarity
  - process_osc_titles() processes binary data chunk by chunk
  - Handles titles split across multiple WebSocket frames
  - Non-title OSC sequences (e.g., hyperlinks) pass through unchanged
  - Added 8 new unit tests for OSC processing
- **Terminfo Upload Endpoint (daemon.rs):**
  - New endpoint: PUT /vms/{vm}/fs?path=/path/to/file
  - Uploads file content to VM via SSH (using sshpass)
  - Security: only allows paths in /usr/share/terminfo/ and /tmp/
  - Rejects uploads to sensitive paths (e.g., /etc, /root)
  - Added upload_file_to_vm() helper function
  - Added route in handle_request() for PUT /vms/{vm}/fs
- **Client-side Terminfo Helper (console.rs):**
  - Added upload_terminfo(vm, term) function
  - Searches standard terminfo paths (/usr/share/terminfo, /lib/terminfo)
  - Uploads local terminfo to VM on every console connect
  - Best-effort: failure doesn't prevent console connection
- Testing verified:
  - File upload to /tmp/test-upload.txt works
  - Terminfo upload to /usr/share/terminfo/x/xterm-256color works
  - Invalid paths (e.g., /etc/passwd) are rejected with 403
- All 101 tests pass with zero clippy warnings
- Commits: 4e3247d, 1dc7fae (always upload terminfo)

### Task 102: Switch to rustls for Cross-Compilation
- Fixed macOS ARM64 cross-compilation failing with native-tls
- Root cause: native-tls links to macOS CoreFoundation/Security frameworks
- Cannot cross-compile from Linux due to missing system libraries
- Solution: Switch to rustls (pure Rust TLS implementation)
- Cargo.toml changes:
  - Changed `tungstenite = { features = ["native-tls"] }` to `features = ["rustls-tls-webpki-roots"]`
  - Removed `native-tls = "0.2"` dependency
- Benefits:
  - Pure Rust implementation - no system dependencies
  - Works with cargo-zigbuild for cross-compilation
  - macOS ARM64 binary now builds successfully on Linux
- All 101 tests pass with zero clippy warnings
- Commit: aaf273b

### Task 102b: Fix WebSocket Handshake Error
- Fixed "Missing, duplicated or incorrect header sec-websocket-key" error
- Root cause: Using `Request::builder()` directly doesn't add WebSocket headers
- tungstenite requires `Sec-WebSocket-Key` header for WebSocket handshake
- Solution: Use `IntoClientRequest` trait to build proper WebSocket request
- Then add custom `Authorization` header via `headers_mut()`
- All 101 tests pass with zero clippy warnings
- Commit: 5cdd2a3

### Task 103: Simplify Console to SSH-based Architecture
- Major rewrite to fix console input freezing issue
- Root cause: Complex PTY storage approach with mutex deadlocks
- **Server changes (daemon.rs):**
  - Replaced PTY master FD storage/retrieval with SSH-based approach
  - When WebSocket connects, spawn: `sshpass -p root ssh -tt root@VM_IP`
  - Pipe WebSocket directly to SSH stdin/stdout via channels
  - SSH handles PTY allocation on VM side (-tt flag)
  - Removed unused functions: set_pty_window_size, parse_resize_message, proxy_websocket_pty
- **Client changes (console.rs):**
  - Replaced mutex-based read/write with channel-based architecture
  - Main thread: reads stdin via poll(), sends to WS thread via channel
  - WS thread: owns WebSocket, handles both send/receive
  - Stdout thread: receives from channel, writes to terminal
  - Key fix: Set 50ms read timeout on TLS stream to prevent ws.read() blocking forever
- **New script (scripts/restart-daemon.sh):**
  - Compiles daemon and macOS binaries (arm64 + x64) using cargo-zigbuild
  - Installs binaries to /usr/local/bin and /var/lib/firecracker/releases
  - Clears logs and restarts daemon
  - Shows download instructions for macOS clients
- Commit: 4052044

### Task 104: Fix Test Failures from Task 103 Cleanup
- Task 103 removed functions but left behind their tests, causing test failures
- Removed obsolete tests for deleted functions:
  - `test_shell_escape()` - tested shell_escape() which was removed
  - `test_parse_resize_message_new_format()` - tested parse_resize_message() which was removed
- Fixed parallel test interference causing flaky test failures:
  - Tests modifying FCM_HOST env var interfered when running in parallel
  - Added `serial_test = "3"` to dev-dependencies (Cargo.toml)
  - Imported `use serial_test::serial;` in client.rs test module
  - Added `#[serial]` attribute to tests that modify FCM_HOST:
    - test_daemon_url_default
    - test_daemon_url_from_env
    - test_daemon_url_with_scheme
- All 99 tests pass with zero clippy warnings
- Commit: 7175cbe

### Task 105: Clean Up Leftover fcm-agent Traces
- Searched codebase for remnants from previous console implementations
- Console went through 3-4 iterations: SSH+tmux → fcm-agent → PTY storage → SSH-based
- Found and removed leftover artifacts:
  - `.gitignore`: Removed `/fcm-agent/target` line (directory deleted in Task 96)
  - `rootfs/fcm-agent`: Deleted 451KB binary (leftover from fcm-agent approach)
- Verified clean:
  - Dockerfile and init script already clean (no fcm-agent references)
  - No session.rs file (deleted in Task 96)
  - No base64 encoding code (removed with fcm-agent protocol)
  - No tmux/agent-related code in src/
- All 99 tests pass with zero clippy warnings
- Commit: 83aaaab

### Task 106: Fix Clippy Warnings for Constant Assertions
- Fixed 3 clippy warnings about assertions with constant values
- Warnings were in test_ip_range_valid() in src/network.rs
- Clippy correctly identified these as constant assertions that should be compile-time
- Changes:
  - Added const block with assertions right after IP_RANGE_START and IP_RANGE_END definitions
  - Const assertions are evaluated at compile time, not runtime
  - Removed redundant test_ip_range_valid() function
- The const block uses `const _: () = { assert!(...); };` pattern
- All 98 tests pass with zero clippy warnings (one less test due to removal)
- Commit: 3ff0d7b

### Task 107: Fix PATH Not Set for zsh Login Shells in VM
- Fixed issue where `bun` and `claude` commands weren't found in VM console
- Root cause: Console SSH runs `exec zsh` without `--login` flag
- Without `--login`, zsh doesn't source `/etc/zsh/zprofile` which sets PATH
- Multiple fixes applied:
  1. rootfs/Dockerfile: Create `/etc/zsh/zprofile` that sources `/etc/profile`
  2. rootfs/init: Pass PATH in setsid command for ttyS0 shell
  3. **daemon.rs**: Change `exec zsh` to `exec zsh --login` for console SSH (key fix)
  4. scripts/restart-daemon.sh: Set RUSTUP_HOME/CARGO_HOME for sudo builds
- Rebuilt base-rootfs.img (855MB sparse)
- Rebuilt macOS client binaries
- All 98 tests pass with zero clippy warnings
- Commits: 0090dd2, 8effb8b, c52df24, c1491e6

### Task 108: Rebuild macOS Client Binaries for WebSocket Console
- User reported console connection error: "Cannot connect to terminal server at 64.34.93.45:7778"
- Root cause: User's fcm client was from before Task 99 (WebSocket migration)
- Old client tried to connect directly to TCP port 7778 (now localhost-only)
- New client uses WebSocket over TLS via Caddy on port 443
- Actions:
  - Ran scripts/restart-daemon.sh to rebuild all binaries
  - Verified releases serve correctly via https://fcm.64-34-93-45.sslip.io/releases/
  - Updated COMMIT file with latest commit: abc2912
- User needs to download updated client:
  `curl -o fcm https://fcm.64-34-93-45.sslip.io/releases/fcm-macos-arm64 && chmod +x fcm`
- All 98 tests pass with zero clippy warnings

### Task 109: Fix Status Page Release Links
- Status page showed old .tar.gz download links instead of new binary names
- Root cause: list_releases() only recognized fcm-<commit>-<platform>.tar.gz format
- src/daemon.rs:
  - Updated list_releases() to recognize new format: fcm-macos-arm64, fcm-macos-x64
  - New format binaries get commit from COMMIT file instead of filename
  - Kept legacy .tar.gz format support for backwards compatibility
  - Added platform display names: "macOS (Apple Silicon)", "macOS (Intel)"
- scripts/restart-daemon.sh:
  - Added cleanup step to remove old .tar.gz files before installing new binaries
  - Removes fcm-*.tar.gz and old fcm-macos files
- Status page now shows correct download links:
  - `/releases/fcm-macos-arm64` → "macOS (Apple Silicon)"
  - `/releases/fcm-macos-x64` → "macOS (Intel)"
- All 98 tests pass with zero clippy warnings
- Commit: e09ada4

### Task 110: Compressed Release Archives with BRT Timezone
- Changed release format from raw binaries to compressed tar.gz archives
- Archives contain binary named "fcm" for easy extraction
- scripts/restart-daemon.sh:
  - Create tar.gz archives with "fcm" as the binary name inside
  - Format: fcm-macos-arm64.tar.gz, fcm-macos-x64.tar.gz
  - Use BRT timezone (America/Sao_Paulo) for COMMIT timestamp
  - Smaller downloads: ~2.2MB compressed vs ~5MB uncompressed
- src/daemon.rs:
  - Updated list_releases() to parse 3-part naming format (fcm-os-arch.tar.gz)
  - Removed support for raw binary files (no extension)
- Status page now shows:
  - Downloads: fcm-macos-arm64.tar.gz, fcm-macos-x64.tar.gz
  - Timestamp in BRT: "2026-01-24 13:43 BRT"
- Install command: `curl -sL URL | tar xz && sudo mv fcm /usr/local/bin/`
- All 98 tests pass with zero clippy warnings
- Commit: a8ddade

### Task 111: Add Linux Binary to Releases
- Added Linux x64 binary to the release archives
- scripts/restart-daemon.sh:
  - Create fcm-linux-x64.tar.gz from target/release/fcm
- src/daemon.rs:
  - Added "linux-x64" => "Linux" platform display name
- Status page now shows three downloads:
  - Linux (fcm-linux-x64.tar.gz)
  - macOS (Apple Silicon) (fcm-macos-arm64.tar.gz)
  - macOS (Intel) (fcm-macos-x64.tar.gz)
- Commit: a17c886

### Task 112: Split Daemon Scripts
- Separated restart-daemon.sh into focused scripts
- New scripts:
  - **build-releases.sh**: Compile all platforms (Linux, macOS ARM64, macOS x64), create tar.gz archives, update COMMIT file
  - **restart-daemon-dev.sh**: For debugging - rebuild binary, clear logs, restart daemon
  - **restart-daemon.sh**: For production - just restart daemon (no rebuild, logs preserved)
- Removed old scripts:
  - build-macos.sh (superseded)
  - build-release.sh (superseded)
- Commit: c283928

## Next Tasks
- None currently - all PRD features complete

### Task 113: Persistent Console Sessions with Reconnection
- Added ability to reconnect to existing console sessions after disconnection
- SSH sessions now persist in daemon even when WebSocket disconnects
- **New ConsoleSession struct** (daemon.rs):
  - Stores session ID, VM info, SSH process, input/output channels
  - Sessions tracked in global `CONSOLE_SESSIONS` store (using once_cell::Lazy)
  - Reader thread broadcasts SSH stdout to all subscribed WebSockets
  - Writer thread receives from channel, writes to SSH stdin
- **CLI changes** (main.rs):
  - `fcm console --ls` - list active sessions
  - `fcm console <vm> -s <session-id>` - reconnect to existing session
- **Client changes** (client.rs):
  - New `list_sessions()` function to fetch sessions from API
  - `console_vm()` now accepts optional session ID
  - Added `status_url()` function for status server API calls
- **Daemon changes** (daemon.rs):
  - GET /sessions endpoint - returns JSON list of active sessions
  - Supports optional `?vm=` filter to list sessions for specific VM
  - Session info sent to client as Text frame on connect: `{"session":"id"}`
  - Session ID displayed in terminal title via OSC sequence
- **Console changes** (console.rs):
  - `connect()` now accepts optional session ID
  - Passes session ID in WebSocket URL query params
  - Displays session ID on connect with reconnection hint
- Added once_cell dependency (Cargo.toml)
- All 98 tests pass with zero clippy warnings
- Commit: 8e1391d

### Task 113b: Auto-cleanup Dead Sessions
- Sessions are now automatically removed when SSH exits
- Reader thread removes session from CONSOLE_SESSIONS when it detects EOF
- No more stale sessions in `fcm console --ls` after user types `exit`
- Commit: 13c9050

### Task 114: Improve Console UX
- Fixed `fcm console ls` to list sessions instead of connecting to VM named "ls"
- Changed CLI to use "ls" as special VM name that triggers session listing
- Removed `--ls` flag in favor of `fcm console ls` subcommand-style syntax
- Session IDs now use single nature words (e.g., "brook" instead of "abc123")
  - Added SESSION_WORDS constant with 42 nature words (brook, cloud, fern, etc.)
  - Simplified from two-word to single-word IDs (users won't have many sessions)
- Help text now shows actual VM name in reconnect hint:
  - Before: "reconnect with: fcm console <vm> -s session"
  - After: "reconnect with: fcm console myvm -s brook"
- Updated `fcm console --help` with clearer examples
- Fixed table alignment in `fcm console ls` output
- All 98 tests pass with zero clippy warnings
- Commits: a495dda, 3256830, c2a0f04

### Task 115: Console Screen Restoration on Reconnect
- Fixed issue where TUI apps (like Claude) lost their screen buffer after disconnect/reconnect
- Root cause: Terminal buffer was stored client-side, lost when WebSocket disconnected
- Solution: Server-side ring buffer (64KB) stores recent PTY output
- **Changes to daemon.rs:**
  - Added `CONSOLE_BUFFER_SIZE` constant (64KB)
  - Added `output_buffer` field to `ConsoleSession` struct (VecDeque<u8>)
  - SSH stdout reader thread now stores output in ring buffer
  - On reconnect, buffer is replayed to client before subscribing to live output
  - Clear screen (ESC[2J + ESC[H) sent before replay for clean state
  - Ctrl+L sent after replay to trigger TUI apps to redraw
- No tmux required - pure server-side buffering
- All 98 tests pass with zero clippy warnings
- Commit: b515dff

### Task 116: Web Console Interface
- Added web-based console using xterm.js for browser access
- **Status page changes:**
  - Added "Create VM" button (visible when logged in)
  - Added "Actions" column to VM table
  - Running VMs show "Console" link to open web console
- **New routes in status server (port 7780):**
  - GET /web-console/{vm} - serves xterm.js console page
  - POST /api/vms - creates VM via web interface
- **Web console features:**
  - Full terminal emulation with xterm.js 5.3.0
  - WebSocket connection to wss://fcm.{ip}.sslip.io/console
  - Fixed session ID "web" for all browser sessions
  - Auto-reconnect with exponential backoff (up to 5 attempts)
  - Proper resize handling on window resize
  - Dark theme matching terminal aesthetics
- **Cookie-based auth for WebSocket:**
  - WebSocket handler now accepts fcm_session cookie in addition to Bearer token
  - Parses cookie from HTTP headers during WebSocket handshake
  - Looks up user from session store and validates access
  - Uses special token format "cookie:{user_id}:{is_admin}" internally
- **Access control:**
  - Web console redirects to login page if not authenticated
  - Checks VM ownership before allowing console access
  - Returns 404 for non-existent VMs, 503 for stopped VMs
- All 98 tests pass with zero clippy warnings
- Commit: b156b2f

### Task 116b: Fix Web Console Session Creation
- Fixed issue where web console showed "connecting, disconnecting" in loop
- Root cause: `session=web` was treated as reconnect request, but session didn't exist yet
- Fix: When session ID is provided but doesn't exist, create new session with that ID
- Previously: Code returned "Session web not found" and connection closed
- Now: Creates session with specified ID (e.g., "web") on first connect
- Commit: 02e447b

### Task 116c: Fix Web Console Per-VM Session IDs
- Fixed issue where web console only worked for the first VM opened
- Root cause: All VMs shared global session ID "web"
- When opening console for a different VM, it failed with "Session web belongs to different VM"
- Fix: Changed session ID format from "web" to "web-{vmName}"
- Now each VM has its own web session (e.g., "web-atomic-comet", "web-nebula-vertex")
- Multiple VMs can have active web console sessions simultaneously
- Commit: 0b6f726

### Task 117: Improve README Documentation
- Comprehensive rewrite of README.md with all new features
- **New sections added:**
  - Console Sessions: Persistent sessions, reconnection, session listing
  - Web Console: Browser-based terminal with xterm.js
  - Admin Token: Alternative to OAuth for server operators
  - Google OAuth Configuration: Step-by-step setup with Google Cloud Console
  - Systemd Service: Production deployment configuration
  - Client Configuration: How to set up the CLI on local machines
  - Architecture diagram: Updated with ports and Caddy routing
  - Ports table: 7777, 7778, 7780, 443, 80
  - Files and Directories: Server and client file locations
  - Environment Variables: Split into server-side and client-side
  - Troubleshooting: Connection, auth, VM, console, SSL, git push, network issues
  - Logs: Where to find daemon, Caddy, and VM logs
  - Updating: How to update binary, base image, and client
- **Updated sections:**
  - Commands: Added `fcm console ls` and `-s` flag for session reconnect
  - Authentication: Split into OAuth and Admin Token sections
  - Quick Start: Fixed console command to include VM name
- All 98 tests pass with zero clippy warnings
- Commit: 95ee46d

### Task 118: Fix GitHub Repository URL in README
- Changed clone URL from `https://github.com/anthropics/fcm.git` to `https://github.com/luisbebop/fcm.git`
- All 98 tests pass
- Commit: 7aa588e

### Task 119: Expand Word Lists to 10,000+ Unique VM Names
- Previously only 441 combinations (21 adjectives × 21 nouns), causing duplicate names
- Expanded ADJECTIVES from 21 to 120 words across 7 themes:
  - Space (20): cosmic, quantum, stellar, galactic, astral, celestial, etc.
  - Tech (20): cyber, digital, neural, binary, atomic, photon, etc.
  - Nature/mineral (20): misty, crystal, amber, coral, emerald, jade, etc.
  - Weather (15): stormy, cloudy, sunny, snowy, frosty, tropical, etc.
  - Descriptive (20): swift, rapid, silent, ancient, eternal, fierce, etc.
  - Color (15): crimson, scarlet, violet, indigo, cobalt, teal, etc.
  - Time (10): twilight, midnight, dawn, dusk, vernal, autumn, etc.
- Expanded NOUNS from 21 to 114 words across 6 themes:
  - Space (20): nova, comet, pulsar, quasar, aurora, galaxy, etc.
  - Tech (20): circuit, matrix, nexus, vertex, tensor, cipher, etc.
  - Terrain (20): river, canyon, glacier, meadow, reef, valley, etc.
  - Animal (20): wolf, bear, eagle, hawk, falcon, tiger, etc.
  - Plant (14): pine, oak, cedar, birch, maple, fern, lotus, etc.
  - Element (20): flame, ember, spark, blaze, frost, storm, etc.
- Total combinations: 120 × 114 = 13,680 unique names
- Added `unique_random_name()` function:
  - Checks existing VM names before generating
  - Fast path: tries 100 random combinations first
  - Fallback: iterates all combinations to find unused name
  - Returns None if all names exhausted (error in create_vm)
- Added `max_unique_names()` function for capacity checking
- Updated `create_vm()` to use `unique_random_name()`
- Added 5 new tests:
  - test_max_unique_names_exceeds_10000
  - test_word_list_sizes (verifies 100+ in each list)
  - test_no_duplicate_adjectives
  - test_no_duplicate_nouns
  - (existing test_random_name_format updated)
- All 102 tests pass with zero clippy warnings
- Commit: bd70e1b

### Task 120: Add Version Flag to CLI
- Added `--version` and `-V` flags to display fcm version
- Uses clap's built-in version support with `#[command(version)]` attribute
- Version automatically pulled from Cargo.toml (currently 0.1.0)
- Help output now shows: `-V, --version  Print version`
- All 102 tests pass with zero clippy warnings
- Commit: 96c314b

### Task 121: Merge PR #1 - Add 'fcm remote' Command
- Merged pull request #1 from feature/remote-command branch
- **New command**: `fcm remote` - sets git remote to FCM deployment target
  - Reads git URL from `.fcm` config (created by `fcm create`)
  - Creates new remote if absent, updates existing one
  - Default remote name: `origin`
  - Custom name: `fcm remote -n deploy`
- **Files added/modified**:
  - src/client.rs: Added `set_remote()` function (+61 lines)
  - src/main.rs: Added `Remote` command variant and handler (+12 lines)
- Proper error handling:
  - "No .fcm file found" when config missing
  - "Not a git repository" when not in git repo
- Colored output consistent with other fcm commands
- All 102 tests pass with zero clippy warnings
- Merge commit: 04f1fc6

### Task 122: Migrate Domain from sslip.io to tryforge.sh
- Changed all domain references from sslip.io to tryforge.sh
- **OAuth changes**:
  - Redirect URI now uses `https://fcm.tryforge.sh/oauth2/callback`
  - Login validation checks for tryforge.sh instead of sslip.io
- **Domain generation**:
  - VM domains now use `{name}.tryforge.sh` format (simpler, no IP in domain)
  - Main service domain is `fcm.tryforge.sh`
  - WebSocket console at `wss://fcm.tryforge.sh/console`
- **Files modified**:
  - src/client.rs: Updated `status_url()`, `status_page_url()`, login validation
  - src/caddy.rs: Updated `generate_domain()` to return `{name}.tryforge.sh`
  - src/daemon.rs: OAuth redirect URIs, WebSocket host, status page comments
  - src/console.rs: WebSocket URL, API URL functions
  - src/vm.rs: Domain fallback, comments
  - src/git.rs: Test domain references
  - README.md: All documentation URLs and examples
  - PRD.md: Specification URLs and examples
  - scripts/build-releases.sh: Download command URLs
- All 102 tests pass with zero clippy warnings
- Commit: e45a2f8
